<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Sistema Ativos</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#07080d;--surface:#0e0f18;--card:#12131f;--card2:#181929;
  --border:#1e2035;--border2:#252640;
  --amber:#f59e0b;--amber-dim:#78501a;--amber-glow:rgba(245,158,11,.12);
  --green:#22c55e;--red:#ef4444;--blue:#3b82f6;--cyan:#06b6d4;
  --purple:#a855f7;
  --text:#e2e4f0;--muted:#565870;--muted2:#3a3c55;
  --r:10px;--r2:16px;--shadow:0 4px 24px rgba(0,0,0,.3);
}
[data-theme="light"]{
  --bg:#f8f9fc;--surface:#ffffff;--card:#ffffff;--card2:#f1f3f9;
  --border:#e5e7f0;--border2:#d8dae5;
  --amber:#d97706;--amber-dim:#fcd34d;--amber-glow:rgba(217,119,6,.08);
  --green:#16a34a;--red:#dc2626;--blue:#2563eb;--cyan:#0891b2;
  --purple:#9333ea;
  --text:#1e2035;--muted:#646882;--muted2:#8a8fa8;
  --shadow:0 4px 24px rgba(30,32,53,.08);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;font-size:14px;transition:background .3s,color .3s}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--amber)}

/* â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfgBanner{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:20px}
.cfg-box{width:100%;max-width:520px;background:var(--card);border:1px solid var(--border2);border-radius:var(--r2);padding:40px;box-shadow:var(--shadow)}
.cfg-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:32px;color:var(--amber);letter-spacing:2px;margin-bottom:4px}
.cfg-desc{color:var(--muted);font-size:13px;margin-bottom:28px;line-height:1.6}
.cfg-label{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600;margin-bottom:6px}
.cfg-input{width:100%;padding:12px 14px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);color:var(--text);font-size:13px;outline:none;transition:.2s;margin-bottom:16px;font-family:'DM Mono',monospace}
.cfg-input:focus{border-color:var(--amber);box-shadow:0 0 0 3px var(--amber-glow)}
.cfg-note{font-size:12px;color:var(--muted);margin-bottom:24px;line-height:1.7;background:var(--surface);padding:14px;border-radius:var(--r);border:1px solid var(--border)}
.cfg-note code{background:rgba(245,158,11,.15);color:var(--amber);padding:2px 6px;border-radius:4px;font-family:'DM Mono',monospace;font-size:11px}
.btn-cfg{width:100%;padding:14px;background:var(--amber);color:#fff;border:none;border-radius:var(--r);font-weight:700;font-size:14px;cursor:pointer;font-family:'Outfit',sans-serif;letter-spacing:.5px;transition:.2s}
.btn-cfg:hover{background:#d97706;transform:translateY(-1px)}
.cfg-err{color:var(--red);font-size:12px;margin-top:10px;min-height:18px;font-family:'DM Mono',monospace}
.cfg-ok{color:var(--green);font-size:12px;margin-top:10px;min-height:18px}

/* â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loginScreen{position:fixed;inset:0;z-index:900;background:var(--bg);display:none;align-items:center;justify-content:center;padding:20px}
#loginScreen.show{display:flex}
.login-wrap{width:100%;max-width:400px;background:var(--card);border:1px solid var(--border2);border-radius:var(--r2);padding:44px 40px;text-align:center;box-shadow:var(--shadow)}
.login-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:40px;color:var(--amber);letter-spacing:3px}
.login-tagline{color:var(--muted);font-size:12px;letter-spacing:2px;text-transform:uppercase;margin-bottom:36px;margin-top:4px}
.field{width:100%;padding:13px 14px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);color:var(--text);font-size:14px;outline:none;transition:.2s;font-family:'Outfit',sans-serif;margin-bottom:12px}
.field:focus{border-color:var(--amber);box-shadow:0 0 0 3px var(--amber-glow)}
.btn-login{width:100%;padding:14px;background:var(--amber);color:#fff;border:none;border-radius:var(--r);font-weight:700;font-size:15px;cursor:pointer;font-family:'Outfit',sans-serif;transition:.2s;letter-spacing:.5px;margin-top:4px}
.btn-login:hover{background:#d97706;transform:translateY(-1px)}
.login-err{color:var(--red);font-size:12px;margin-top:12px;min-height:18px;font-family:'DM Mono',monospace}
.login-info{color:var(--muted);font-size:11px;margin-top:8px;font-family:'DM Mono',monospace}
.spin-wrap{display:none;color:var(--muted);font-size:13px;margin-top:10px}
.spin{display:inline-block;width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--amber);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:none;height:100vh;flex-direction:row}
#app.show{display:flex}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar{width:260px;min-width:260px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;overflow-y:auto;flex-shrink:0;transition:transform .3s ease;z-index:600}
.sb-top{padding:20px 20px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px}
.sb-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:22px;color:var(--amber);letter-spacing:1px;white-space:nowrap;display:flex;align-items:center;gap:8px}
.sb-close{display:none;padding:8px;background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:18px;border-radius:6px;transition:.2s}
.sb-close:hover{color:var(--text);background:var(--surface)}
.sb-user{flex:1;min-width:0;padding:8px 12px;background:var(--surface);border-radius:var(--r)}
.sb-user-name{font-size:13px;color:var(--text);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-user-email{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-nav{flex:1;padding:8px 0;overflow-y:auto}
.sb-section{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted2);padding:14px 20px 6px;font-weight:600}
.sb-link{display:flex;align-items:center;gap:12px;padding:11px 20px;cursor:pointer;color:var(--muted);font-size:13px;font-weight:500;transition:.15s;border-left:3px solid transparent;user-select:none;border-radius:0 8px 8px 0;margin:0 4px}
.sb-link:hover{color:var(--text);background:rgba(245,158,11,.06)}
.sb-link.active{color:var(--amber);background:var(--amber-glow);border-left-color:var(--amber)}
.sb-link .ico{width:20px;text-align:center;font-size:16px;flex-shrink:0}
.sb-bottom{padding:12px 20px 20px;border-top:1px solid var(--border)}
.btn-logout{width:100%;padding:11px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:var(--red);border-radius:var(--r);cursor:pointer;font-size:12px;font-weight:600;font-family:'Outfit',sans-serif;transition:.2s;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-logout:hover{background:rgba(239,68,68,.2);border-color:var(--red)}

/* â”€â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
#topbar{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--card);flex-shrink:0;gap:10px;position:sticky;top:0;z-index:100}
.tb-left{display:flex;align-items:center;gap:12px;min-width:0}
#menuToggle{display:none;padding:10px 12px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);color:var(--text);cursor:pointer;font-size:18px;transition:.2s;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}
#menuToggle:active{transform:scale(.95)}
.tb-title{font-family:'Syne',sans-serif;font-weight:700;font-size:17px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tb-sub{font-size:11px;color:var(--muted);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tb-acts{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
#themeToggle{padding:9px 12px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);color:var(--text);cursor:pointer;font-size:12px;transition:.2s;display:flex;align-items:center;gap:5px;min-height:36px}
#themeToggle:hover{border-color:var(--amber);color:var(--amber)}
#content{flex:1;overflow-y:auto;padding:20px;scroll-behavior:smooth}
.page{display:none;animation:fadeIn .2s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€â”€ BOTÃ•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{padding:9px 16px;border-radius:var(--r);font-size:12px;font-weight:600;cursor:pointer;border:none;transition:.2s;font-family:'Outfit',sans-serif;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;min-height:36px}
.btn-primary{background:var(--amber);color:#fff}
.btn-primary:hover{background:#d97706;transform:translateY(-1px)}
.btn-ghost{background:var(--surface);color:var(--text);border:1px solid var(--border2)}
.btn-ghost:hover{border-color:var(--amber);color:var(--amber)}
.btn-danger{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)}
.btn-danger:hover{background:rgba(239,68,68,.2)}
.btn-blue{background:rgba(59,130,246,.1);color:var(--blue);border:1px solid rgba(59,130,246,.2)}
.btn-blue:hover{background:rgba(59,130,246,.2)}
.btn-purple{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.btn-purple:hover{background:rgba(168,85,247,.2)}
.btn-sm{padding:6px 12px;font-size:11px;min-height:32px}

/* â”€â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin-bottom:22px}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:18px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s}
.kpi:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.kpi::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--amber),transparent)}
.kpi.kpi-purple::after{background:linear-gradient(90deg,var(--purple),transparent)}
.kpi.kpi-green::after{background:linear-gradient(90deg,var(--green),transparent)}
.kpi.kpi-cyan::after{background:linear-gradient(90deg,var(--cyan),transparent)}
.kpi-label{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600;margin-bottom:8px}
.kpi-value{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;color:var(--text);line-height:1.1}
.kpi-value.amber{color:var(--amber)}.kpi-value.green{color:var(--green)}.kpi-value.red{color:var(--red)}.kpi-value.blue{color:var(--blue)}.kpi-value.purple{color:var(--purple)}.kpi-value.cyan{color:var(--cyan)}
.kpi-sub{font-size:10px;color:var(--muted);margin-top:5px}

/* â”€â”€â”€ CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:18px;margin-bottom:20px}
.chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px}
.chart-title{font-weight:600;font-size:14px}
.chart-body{display:flex;align-items:flex-end;gap:6px;height:110px;padding:6px 0}
.bar{flex:1;min-width:24px;border-radius:5px 5px 0 0;position:relative;background:linear-gradient(180deg,var(--amber) 0%,var(--amber-dim) 100%);transition:.3s;cursor:default}
.bar.bar-purple{background:linear-gradient(180deg,var(--purple) 0%,rgba(168,85,247,.3) 100%)}
.bar.bar-green{background:linear-gradient(180deg,var(--green) 0%,rgba(34,197,94,.3) 100%)}
.bar:hover{filter:brightness(1.1)}
.bar:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid var(--border2);padding:5px 9px;border-radius:7px;font-size:10px;color:var(--amber);white-space:nowrap;pointer-events:none;font-family:'DM Mono',monospace;z-index:10;box-shadow:var(--shadow)}
.chart-labels{display:flex;gap:6px;margin-top:6px}
.chart-labels span{flex:1;text-align:center;font-size:8px;color:var(--muted);font-family:'DM Mono',monospace;overflow:hidden;text-overflow:ellipsis}

/* â”€â”€â”€ TABELA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tcard{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;margin-bottom:16px}
.tcard-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px}
.tcard-title{font-weight:600;font-size:14px}
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:550px}
thead th{padding:11px 12px;text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);font-weight:600;background:var(--surface);white-space:nowrap;position:sticky;top:0;z-index:1}
tbody tr{border-top:1px solid var(--border);transition:.15s}
tbody tr:hover{background:rgba(245,158,11,.04)}
tbody td{padding:11px 12px;color:var(--text);white-space:nowrap;vertical-align:middle;font-size:13px}
.td-ticker{font-family:'DM Mono',monospace;font-weight:500;color:var(--amber);font-size:13px}
.td-pos{color:var(--green);font-weight:600;font-family:'DM Mono',monospace}
.td-neg{color:var(--red);font-weight:600;font-family:'DM Mono',monospace}
.td-num{font-family:'DM Mono',monospace}
.td-empty{text-align:center;color:var(--muted);padding:35px!important}
.td-acts{display:flex;gap:5px}
.loading-row{text-align:center;padding:40px;color:var(--muted)}

/* â”€â”€â”€ BADGE MODO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.5px;font-family:'DM Mono',monospace}
.badge-dia{background:rgba(6,182,212,.15);color:var(--cyan);border:1px solid rgba(6,182,212,.3)}
.badge-perc{background:rgba(168,85,247,.15);color:var(--purple);border:1px solid rgba(168,85,247,.3)}

/* â”€â”€â”€ PROVENTO CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pv-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:16px 20px;margin-bottom:10px;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;transition:.2s}
.pv-card:hover{border-color:var(--border2);box-shadow:var(--shadow)}
.pv-ticker{font-family:'Syne',sans-serif;font-weight:700;font-size:18px;color:var(--amber)}
.pv-meta{font-size:11px;color:var(--muted);margin-top:2px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pv-stats{display:flex;gap:20px;text-align:right}
.pv-stat-label{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:600}
.pv-stat-val{font-family:'DM Mono',monospace;font-weight:500;font-size:14px;margin-top:2px}
.pv-stat-val.green{color:var(--green)}
.pv-stat-val.purple{color:var(--purple)}
.pv-stat-val.cyan{color:var(--cyan)}
.pv-actions{display:flex;gap:6px;margin-top:8px}
.pv-bar-wrap{background:var(--surface);border-radius:4px;height:4px;margin-top:10px;overflow:hidden}
.pv-bar-inner{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--amber),var(--green));transition:.4s}

/* â”€â”€â”€ FILTRO PROVENTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pv-filter{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.pv-filter-btn{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border2);background:var(--surface);color:var(--muted);transition:.2s;font-family:'Outfit',sans-serif}
.pv-filter-btn.active{background:var(--amber-glow);border-color:var(--amber);color:var(--amber)}
.pv-filter-btn:hover{border-color:var(--amber);color:var(--amber)}

/* â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(7,8,13,.75);z-index:800;display:none;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(3px)}
[data-theme="light"] .overlay{background:rgba(30,32,53,.55)}
.overlay.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border2);border-radius:var(--r2);padding:24px;width:100%;max-width:560px;max-height:88vh;overflow-y:auto;box-shadow:var(--shadow);animation:modalIn .2s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
.modal-title{font-family:'Syne',sans-serif;font-weight:700;font-size:20px;color:var(--amber);margin-bottom:20px;letter-spacing:1px}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg{display:flex;flex-direction:column;gap:5px}
.fg.full{grid-column:span 2}
.fg label{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600}
.fg input,.fg select,.fg textarea{padding:10px 11px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);color:var(--text);font-size:13px;outline:none;transition:.2s;font-family:'Outfit',sans-serif;min-height:40px}
.fg select{cursor:pointer}
.fg input:focus,.fg select:focus{border-color:var(--amber);box-shadow:0 0 0 3px var(--amber-glow)}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;flex-wrap:wrap}
.btn-cancel{padding:9px 18px;background:transparent;border:1px solid var(--border2);color:var(--muted);border-radius:var(--r);cursor:pointer;font-size:13px;font-family:'Outfit',sans-serif;transition:.2s;min-height:38px}
.btn-cancel:hover{color:var(--text);border-color:var(--muted)}
.btn-save{padding:9px 22px;background:var(--amber);color:#fff;border:none;border-radius:var(--r);font-weight:700;font-size:13px;cursor:pointer;font-family:'Outfit',sans-serif;min-height:38px}
.btn-save:hover{background:#d97706}

/* â”€â”€â”€ MODO TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modo-toggle{display:flex;gap:0;border:1px solid var(--border2);border-radius:var(--r);overflow:hidden;margin-bottom:16px}
.modo-btn{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:600;cursor:pointer;background:var(--surface);color:var(--muted);border:none;font-family:'Outfit',sans-serif;transition:.2s}
.modo-btn.active{background:var(--amber);color:#fff}
.modo-dia{display:block}.modo-perc{display:none}

/* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast{position:fixed;bottom:20px;right:16px;left:16px;z-index:9999;background:var(--card2);border:1px solid var(--border2);border-radius:var(--r2);padding:12px 16px;font-size:13px;pointer-events:none;transform:translateY(12px);opacity:0;transition:.25s;max-width:400px;box-shadow:var(--shadow);display:flex;align-items:center;gap:10px;margin:0 auto}
#toast.show{transform:translateY(0);opacity:1}
#toast.ok{border-color:var(--green);color:var(--green)}
#toast.err{border-color:var(--red);color:var(--red)}
#toast.info{border-color:var(--amber);color:var(--amber)}
.toast-ico{font-size:17px;flex-shrink:0}

/* â”€â”€â”€ BACKDROP MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebarBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:none;backdrop-filter:blur(2px)}
#sidebarBackdrop.show{display:block;animation:fadeIn .2s}

/* â”€â”€â”€ RESPONSIVO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:768px){
  #sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);width:280px;min-width:280px;z-index:700;box-shadow:var(--shadow)}
  #sidebar.open{transform:translateX(0)}
  .sb-close{display:flex}
  #menuToggle{display:flex}
  .cards{grid-template-columns:1fr 1fr}
  .fgrid{grid-template-columns:1fr}
  .fg.full{grid-column:span 1}
  #content{padding:14px}
  #topbar{padding:10px 14px}
  .tb-title{font-size:16px}
  .tb-acts{gap:4px}
  .btn{padding:8px 14px;font-size:11px}
  .btn-sm{padding:5px 10px;font-size:10px}
  table{min-width:500px;font-size:12px}
  thead th{padding:9px 10px;font-size:8px}
  tbody td{padding:9px 10px}
  .kpi{padding:16px}
  .kpi-value{font-size:20px}
  .pv-card{grid-template-columns:1fr;gap:8px}
  .pv-stats{text-align:left;justify-content:flex-start}
}
@media(max-width:400px){
  .cards{grid-template-columns:1fr}
  .pv-stats{gap:12px}
}
</style>
</head>
<body>

<!-- â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="cfgBanner">
  <div class="cfg-box">
    <div class="cfg-logo">âš™ CONFIGURAR API</div>
    <div class="cfg-desc" style="margin-top:6px">
      Cole abaixo a URL do <strong style="color:var(--text)">Apps Script Web App</strong> implantado na sua planilha SISTEMA ATIVOS.
    </div>
    <div class="cfg-label">URL do Web App</div>
    <input class="cfg-input" id="cfgUrl" type="url" placeholder="https://script.google.com/macros/s/XXXXXX/exec"/>
    <div class="cfg-note">
      <strong style="color:var(--text)">Como obter a URL:</strong><br>
      1. Planilha â†’ <code>ExtensÃµes</code> â†’ <code>Apps Script</code><br>
      2. Cole o <code>Code.gs</code> fornecido<br>
      3. Execute <code>inicializarPlanilha()</code> e <code>criarTriggers()</code><br>
      4. <code>Implantar</code> â†’ <code>Nova implantaÃ§Ã£o</code> â†’ Tipo: <code>Aplicativo da Web</code><br>
      5. Executar como: <code>Eu</code> | Acesso: <code>Qualquer pessoa</code><br>
      6. Copie e cole a URL aqui
    </div>
    <button class="btn-cfg" onclick="salvarConfig()">TESTAR E CONECTAR</button>
    <div class="cfg-err" id="cfgErr"></div>
    <div class="cfg-ok"  id="cfgOk"></div>
  </div>
</div>

<!-- â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loginScreen">
  <div class="login-wrap">
    <div class="login-logo">ATIVOS</div>
    <div class="login-tagline">GestÃ£o de Investimentos</div>
    <input class="field" id="lEmail" type="email" placeholder="Email (cadastrado na aba UsuÃ¡rios)"/>
    <input class="field" id="lSenha" type="password" placeholder="Senha"/>
    <button class="btn-login" onclick="fazerLogin()">ENTRAR</button>
    <div class="spin-wrap" id="lSpin"><span class="spin"></span>Verificando...</div>
    <div class="login-err" id="lErr"></div>
    <div class="login-info" id="lInfo"></div>
    <div style="margin-top:18px;font-size:11px">
      <a href="#" onclick="resetConfig()" style="color:var(--muted2);text-decoration:none">â†© Trocar URL da API</a>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app">
  <div id="sidebar">
    <div class="sb-top">
      <div class="sb-logo">âš¡ ATIVOS</div>
      <button class="sb-close" onclick="closeSidebar()">âœ•</button>
    </div>
    <div class="sb-user">
      <div class="sb-user-name" id="sbNome">â€”</div>
      <div class="sb-user-email" id="sbEmail">â€”</div>
    </div>
    <nav class="sb-nav">
      <div class="sb-section">Principal</div>
      <div class="sb-link active" onclick="nav(this,'dashboard')"><span class="ico">â—‰</span><span>Dashboard</span></div>
      <div class="sb-section">Renda Fixa</div>
      <div class="sb-link" onclick="nav(this,'cdb')"><span class="ico">ğŸ¦</span><span>CDB</span></div>
      <div class="sb-section">FIIs</div>
      <div class="sb-link" onclick="nav(this,'fiisC')"><span class="ico">ğŸ¢</span><span>FIIs Comprados</span></div>
      <div class="sb-link" onclick="nav(this,'fiisN')"><span class="ico">ğŸ‘</span><span>FIIs Watchlist</span></div>
      <div class="sb-section">AÃ§Ãµes</div>
      <div class="sb-link" onclick="nav(this,'acC')"><span class="ico">ğŸ“ˆ</span><span>AÃ§Ãµes Compradas</span></div>
      <div class="sb-link" onclick="nav(this,'acN')"><span class="ico">ğŸ”</span><span>AÃ§Ãµes Watchlist</span></div>
      <div class="sb-section">Proventos</div>
      <div class="sb-link" onclick="nav(this,'proventos')"><span class="ico">ğŸ’</span><span>Proventos</span></div>
      <div class="sb-section">GestÃ£o</div>
      <div class="sb-link" onclick="nav(this,'aportes')"><span class="ico">ğŸ’°</span><span>Aportes</span></div>
      <div class="sb-link" onclick="nav(this,'historico')"><span class="ico">ğŸ“…</span><span>HistÃ³rico</span></div>
      <div class="sb-link" onclick="nav(this,'usuarios')"><span class="ico">ğŸ‘¤</span><span>UsuÃ¡rios</span></div>
    </nav>
    <div class="sb-bottom">
      <button class="btn-logout" onclick="confirmLogout()">â» Sair do Sistema</button>
    </div>
  </div>
  
  <div id="sidebarBackdrop" onclick="closeSidebar()"></div>

  <div id="main">
    <div id="topbar">
      <div class="tb-left">
        <button id="menuToggle" onclick="toggleSidebar()" aria-label="Abrir menu">â˜°</button>
        <div>
          <div class="tb-title" id="tbTitle">Dashboard</div>
          <div class="tb-sub"  id="tbSub">VisÃ£o geral em tempo real</div>
        </div>
      </div>
      <div class="tb-acts" id="tbActs"></div>
      <button id="themeToggle" onclick="toggleTheme()" aria-label="Alternar tema">ğŸŒ™</button>
    </div>
    <div id="content">
      <div class="page active" id="pg-dashboard"></div>
      <div class="page" id="pg-cdb"></div>
      <div class="page" id="pg-fiisC"></div>
      <div class="page" id="pg-fiisN"></div>
      <div class="page" id="pg-acC"></div>
      <div class="page" id="pg-acN"></div>
      <div class="page" id="pg-proventos"></div>
      <div class="page" id="pg-aportes"></div>
      <div class="page" id="pg-historico"></div>
      <div class="page" id="pg-usuarios"></div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay" id="overlay" onclick="closeModalOutside(event)">
  <div class="modal" id="modalBox">
    <div class="modal-title" id="modalTitle">Novo Registro</div>
    <div id="modalForm"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn-save"   onclick="saveModal()">Salvar</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast"><span class="toast-ico" id="toastIco">â„¹</span><span id="toastMsg"></span></div>

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG & THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let API = '';
const LS_URL   = 'siativos_url';
const LS_USR   = 'siativos_usr';
const LS_THEME = 'siativos_theme';

function toggleTheme(){
  const html = document.documentElement;
  const next = (html.getAttribute('data-theme')||'dark') === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem(LS_THEME, next);
  document.getElementById('themeToggle').textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
}
function initTheme(){
  const saved = localStorage.getItem(LS_THEME) || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  document.getElementById('themeToggle').textContent = saved === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
}

async function apiGet(action, params = {}) {
  const qs  = new URLSearchParams({ action, ...params }).toString();
  const r   = await fetch(`${API}?${qs}`, { method:'GET', redirect:'follow' });
  const txt = await r.text();
  let d;
  try { d = JSON.parse(txt); } catch(_) { throw new Error('Resposta invÃ¡lida: ' + txt.slice(0,200)); }
  if (d.error) throw new Error(d.error);
  return d;
}
async function apiWrite(action, params = {}) {
  const p = { ...params };
  if (p.linha && Array.isArray(p.linha)) p.linha = JSON.stringify(p.linha);
  return apiGet(action, p);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function salvarConfig() {
  const url = document.getElementById('cfgUrl').value.trim();
  if (!url.startsWith('https://script.google.com')) {
    setErr('cfgErr','URL invÃ¡lida. Deve comeÃ§ar com https://script.google.com');
    return;
  }
  setErr('cfgErr','â³ Testando conexÃ£o...');
  document.getElementById('cfgOk').textContent = '';
  try {
    const r = await fetch(`${url}?action=ping`, { method:'GET', redirect:'follow' });
    const d = JSON.parse(await r.text());
    if (d.ok) {
      localStorage.setItem(LS_URL, url);
      API = url;
      setErr('cfgErr','');
      document.getElementById('cfgBanner').style.display = 'none';
      document.getElementById('loginScreen').classList.add('show');
      toast('API conectada com sucesso!','ok');
    } else {
      setErr('cfgErr','Resposta inesperada: ' + JSON.stringify(d));
    }
  } catch(e) {
    setErr('cfgErr','Erro: ' + e.message);
  }
}
function resetConfig() {
  localStorage.removeItem(LS_URL);
  localStorage.removeItem(LS_USR);
  location.reload();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN & LOGOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentUser = null;
async function fazerLogin() {
  const email = document.getElementById('lEmail').value.trim();
  const senha = document.getElementById('lSenha').value.trim();
  if (!email || !senha) { setErr('lErr','Preencha email e senha.'); return; }
  setErr('lErr','');
  document.getElementById('lInfo').textContent = '';
  document.getElementById('lSpin').style.display = 'block';
  document.getElementById('lInfo').textContent = `Verificando: ${email}`;
  try {
    const res = await apiGet('autenticar', { email, senha });
    document.getElementById('lSpin').style.display = 'none';
    if (res.ok) {
      currentUser = res;
      localStorage.setItem(LS_USR, JSON.stringify(res));
      document.getElementById('loginScreen').classList.remove('show');
      document.getElementById('app').classList.add('show');
      document.getElementById('sbNome').textContent  = res.nome;
      document.getElementById('sbEmail').textContent = res.email;
      carregarPagina('dashboard');
    } else {
      setErr('lErr', res.msg || 'Acesso negado.');
      document.getElementById('lInfo').textContent = 'Verifique email/senha na aba "UsuÃ¡rios" da planilha.';
    }
  } catch(e) {
    document.getElementById('lSpin').style.display = 'none';
    setErr('lErr', 'Erro de comunicaÃ§Ã£o: ' + e.message);
  }
}
function confirmLogout(){ if(confirm('Deseja realmente sair?')) logout(); }
function logout() {
  currentUser = null;
  localStorage.removeItem(LS_USR);
  document.getElementById('app').classList.remove('show');
  document.getElementById('loginScreen').classList.add('show');
  document.getElementById('lEmail').value = '';
  document.getElementById('lSenha').value = '';
  setErr('lErr','');
  document.getElementById('lInfo').textContent = '';
  closeSidebar();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR MOBILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarBackdrop').classList.toggle('show');
}
function closeSidebar(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarBackdrop').classList.remove('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVEGAÃ‡ÃƒO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PAGES = {
  dashboard: { title:'Dashboard',       sub:'VisÃ£o geral em tempo real',          load:loadDashboard,                              acts:dashActs },
  cdb:       { title:'CDB',             sub:'Renda fixa e tÃ­tulos',               load:()=>loadTabela('CDB','cdb'),                acts:()=>tableActs('CDB','cdb','CDB_FORM') },
  fiisC:     { title:'FIIs Comprados',  sub:'Fundos em carteira',                 load:()=>loadTabela('FIIS_COMPRADOS','fiisC'),   acts:()=>tableActs('FIIS_COMPRADOS','fiisC','FII',true) },
  fiisN:     { title:'FIIs Watchlist',  sub:'Fundos em anÃ¡lise',                  load:()=>loadTabela('FIIS_NAO_COMPRADOS','fiisN'), acts:()=>tableActs('FIIS_NAO_COMPRADOS','fiisN','FII') },
  acC:       { title:'AÃ§Ãµes Compradas', sub:'Renda variÃ¡vel em carteira',         load:()=>loadTabela('ACOES_COMPRADOS','acC'),    acts:()=>tableActs('ACOES_COMPRADOS','acC','ACAO',true) },
  acN:       { title:'AÃ§Ãµes Watchlist', sub:'AÃ§Ãµes em anÃ¡lise',                   load:()=>loadTabela('ACOES_NAO_COMPRADOS','acN'), acts:()=>tableActs('ACOES_NAO_COMPRADOS','acN','ACAO') },
  proventos: { title:'Proventos',       sub:'Rendimentos por ativo',              load:loadProventos,                              acts:proventosActs },
  aportes:   { title:'Aportes',         sub:'Registro de compras mensais',        load:()=>loadTabela('APORTES','aportes'),        acts:()=>tableActs('APORTES','aportes','APORTE') },
  historico: { title:'HistÃ³rico',       sub:'EvoluÃ§Ã£o mensal do patrimÃ´nio',      load:()=>loadTabela('HISTORICO','historico'),    acts:()=>[] },
  usuarios:  { title:'UsuÃ¡rios',        sub:'Controle de acesso ao sistema',      load:loadUsuarios,                              acts:()=>tableActs('USUARIOS','usuarios','USR') },
};
let activePage = 'dashboard';
let _pvFiltro  = 'TODOS';

function nav(el, page) {
  document.querySelectorAll('.sb-link').forEach(l => l.classList.remove('active'));
  el.classList.add('active');
  closeSidebar();
  carregarPagina(page);
}
function carregarPagina(page) {
  activePage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('pg-' + page).classList.add('active');
  const pg = PAGES[page];
  document.getElementById('tbTitle').textContent = pg.title;
  document.getElementById('tbSub').textContent   = pg.sub;
  const acts = pg.acts();
  document.getElementById('tbActs').innerHTML = acts.map(a =>
    `<button class="btn ${a.cls}" onclick="${a.fn}">${a.label}</button>`
  ).join('');
  pg.load();
}
function dashActs() {
  return [
    { label:'â†» Refresh',  cls:'btn-ghost btn-sm',   fn:'loadDashboard()' },
    { label:'âŸ³ PreÃ§os',   cls:'btn-ghost btn-sm',   fn:'acionarPrecos()' },
  ];
}
function tableActs(aba, pg, tipo, comPrecos=false) {
  const acts = [
    { label:'â†»', cls:'btn-ghost btn-sm', fn:`reloadTable('${aba}','${pg}')` },
    { label:'+ Novo', cls:'btn-primary btn-sm', fn:`openModal('${aba}','${pg}',null,null,'${tipo}')` },
  ];
  if (comPrecos) acts.splice(1,0,{ label:'âŸ³', cls:'btn-ghost btn-sm', fn:'acionarPrecos()' });
  return acts;
}
function proventosActs() {
  return [
    { label:'â†»', cls:'btn-ghost btn-sm', fn:'loadProventos()' },
    { label:'+ Novo Provento', cls:'btn-primary btn-sm', fn:"openProventoModal(null,null)" },
  ];
}
function reloadTable(aba, pg) { loadTabela(aba, pg); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMATAÃ‡ÃƒO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(v) {
  return 'R$\u00A0' + parseFloat(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
}
function pct(v) {
  const n = parseFloat(v||0);
  return (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadDashboard() {
  el('pg-dashboard').innerHTML = loading();
  try {
    const d = await apiGet('getDashboard');
    renderDashboard(d);
  } catch(e) { el('pg-dashboard').innerHTML = `<div class="loading-row" style="color:var(--red)">Erro: ${e.message}</div>`; }
}
function renderDashboard(d) {
  const kpis = [
    { l:'PatrimÃ´nio',      v:fmt(d.patrim),          c:'amber',  s:'Total',          extra:'' },
    { l:'Investido',       v:fmt(d.totalInv),         c:'',       s:'FIIs+AÃ§Ãµes',     extra:'' },
    { l:'Retorno',         v:pct(d.retGeral),         c:parseFloat(d.retGeral)>=0?'green':'red', s:'Geral', extra:'' },
    { l:'FIIs',            v:fmt(d.fiiC.atual),       c:'blue',   s:d.fiiC.qtd+' ativos', extra:'' },
    { l:'AÃ§Ãµes',           v:fmt(d.acC.atual),        c:'',       s:d.acC.qtd+' ativos', extra:'' },
    { l:'CDB',             v:fmt(d.cdb.atual),        c:'',       s:'Renda fixa',     extra:'' },
    { l:'Aporte MÃªs',      v:fmt(d.aporteMes),        c:'',       s:'Este mÃªs',       extra:'' },
    { l:'Proventos/MÃªs',   v:fmt(d.proventosMes||0),  c:'purple', s:'Estimado',       extra:'kpi-purple' },
    { l:'Proventos/Ano',   v:fmt(d.proventosAno||0),  c:'cyan',   s:'Estimado',       extra:'kpi-cyan' },
    { l:'Watchlist',       v:d.fiiN.qtd+' ativos',    c:'',       s:fmt(d.fiiN.atual), extra:'' },
  ];
  let h = '<div class="cards">' + kpis.map(k=>
    `<div class="kpi ${k.extra}"><div class="kpi-label">${k.l}</div><div class="kpi-value ${k.c}">${k.v}</div><div class="kpi-sub">${k.s}</div></div>`
  ).join('') + '</div>';

  // GrÃ¡fico histÃ³rico
  const rows = (d.historico && d.historico.rows) ? d.historico.rows.slice(-10) : [];
  h += `<div class="chart-card"><div class="chart-head"><span class="chart-title">EvoluÃ§Ã£o Patrimonial</span><span style="font-size:10px;color:var(--muted)">Ãšltimos meses</span></div>`;
  if (rows.length) {
    const vals = rows.map(r => parseFloat(r[3])||0), mx = Math.max(...vals,1);
    h += '<div class="chart-body">' + vals.map(v=>
      `<div class="bar" style="height:${Math.max(4,Math.round(v/mx*100))}%" data-tip="${fmt(v)}"></div>`
    ).join('') + '</div>';
    h += '<div class="chart-labels">' + rows.map(r=>`<span>${r[0]||''}</span>`).join('') + '</div>';
  } else {
    h += '<div style="color:var(--muted);font-size:12px;padding:8px 0">Sem histÃ³rico ainda.</div>';
  }
  h += '</div>';

  h += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px">
    ${miniRes('FIIs',d.fiiC)}
    ${miniRes('AÃ§Ãµes',d.acC)}
  </div>`;
  el('pg-dashboard').innerHTML = h;
}
function miniRes(t, d) {
  return `<div class="tcard"><div class="tcard-head"><span class="tcard-title">${t}</span></div>
  <div style="padding:12px 16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
    <div><div style="font-size:9px;color:var(--muted);text-transform:uppercase">Investido</div><div style="font-family:'DM Mono';margin-top:3px">${fmt(d.investido)}</div></div>
    <div><div style="font-size:9px;color:var(--muted);text-transform:uppercase">Atual</div><div style="font-family:'DM Mono';margin-top:3px">${fmt(d.atual)}</div></div>
    <div><div style="font-size:9px;color:var(--muted);text-transform:uppercase">Retorno</div><div style="font-family:'DM Mono';margin-top:3px;color:${parseFloat(d.retorno)>=0?'var(--green)':'var(--red)'}">${pct(d.retorno)}</div></div>
  </div></div>`;
}
async function acionarPrecos() {
  toast('Atualizando preÃ§os...','info');
  try {
    const r = await apiGet('atualizarPrecos');
    toast(`âœ“ ${r.atualizados} atualizados`,'ok');
    carregarPagina(activePage);
  } catch(e) { toast('Erro: '+e.message,'err'); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABELAS GENÃ‰RICAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const COLS = {
  CDB:                { h:['Ticker','Tipo','Qtd','P.MÃ©dio','P.Atual','V.Investido','V.Atual','Retorno%','DY%','Ãšltimo DY','Atualizado'], money:[3,4,5,6,9], pct:[7,8] },
  FIIS_COMPRADOS:     { h:['Ticker','Tipo','Qtd','P.MÃ©dio','P.Atual','V.Investido','V.Atual','Retorno%','DY%','Ãšltimo DY','Atualizado'], money:[3,4,5,6,9], pct:[7,8] },
  FIIS_NAO_COMPRADOS: { h:['Ticker','Tipo','Qtd','P.Alvo','P.Atual','V.Investido','V.Atual','Retorno%','DY%','Ãšltimo DY','Atualizado'],  money:[3,4,5,6,9], pct:[7,8] },
  ACOES_COMPRADOS:    { h:['Ticker','Setor','Qtd','P.MÃ©dio','P.Atual','V.Investido','V.Atual','Retorno%','P/L','Atualizado'],             money:[3,4,5,6],   pct:[7] },
  ACOES_NAO_COMPRADOS:{ h:['Ticker','Setor','Qtd','P.Alvo','P.Atual','V.Investido','V.Atual','Retorno%','P/L','Atualizado'],              money:[3,4,5,6],   pct:[7] },
  APORTES:            { h:['Data','Ticker','Tipo','Qtd','PreÃ§o','Total','Corretora','ObservaÃ§Ã£o'],                                         money:[4,5],       pct:[] },
  HISTORICO:          { h:['Data','Carteira','Aporte MÃªs','PatrimÃ´nio','Rend.MÃªs','Rend.Acum.'],                                          money:[2,3,4,5],   pct:[] },
  USUARIOS:           { h:['Nome','Email','Senha'],                                                                                        money:[],          pct:[] },
};
async function loadTabela(aba, pg) {
  el('pg-'+pg).innerHTML = loading();
  try {
    const d   = await apiGet('lerAba', { aba });
    const cfg = COLS[aba] || { h: d.headers, money:[], pct:[] };
    const rows= d.rows || [];
    let h = '<div class="tcard"><div class="table-wrap"><table><thead><tr>' +
      cfg.h.map(c=>`<th>${c}</th>`).join('') + '<th></th></tr></thead><tbody>';
    if (!rows.length) h += `<tr><td colspan="${cfg.h.length+1}" class="td-empty">Nenhum registro. Toque em "+ Novo".</td></tr>`;
    rows.forEach((row,ri) => {
      h += '<tr>';
      row.forEach((cell,ci) => {
        let v = (cell!==null&&cell!==undefined&&cell!=='') ? cell : 'â€”';
        let c = 'td-num';
        if (ci===0) c='td-ticker';
        if (cfg.pct.includes(ci)) {
          const n=parseFloat(v); c=isNaN(n)?'':(n>=0?'td-pos':'td-neg');
          v=isNaN(n)?v:(n>=0?'+':'')+n.toFixed(2)+'%';
        } else if (cfg.money.includes(ci)&&!isNaN(parseFloat(v))&&v!=='â€”') {
          v=fmt(v);
        }
        h+=`<td class="${c}">${v}</td>`;
      });
      h+=`<td><div class="td-acts">
        <button class="btn btn-blue btn-sm" onclick="editarLinha('${aba}','${pg}',${ri})">âœ</button>
        <button class="btn btn-danger btn-sm" onclick="excluirLinha('${aba}','${pg}',${ri+1})">âœ•</button>
      </div></td></tr>`;
    });
    h+='</tbody></table></div></div>';
    el('pg-'+pg).innerHTML=h;
  } catch(e){ el('pg-'+pg).innerHTML=`<div class="loading-row" style="color:var(--red)">Erro: ${e.message}</div>`; }
}
async function loadUsuarios() {
  el('pg-usuarios').innerHTML = loading();
  try {
    const d=await apiGet('lerAba',{aba:'USUARIOS'});
    let h='<div class="tcard"><div class="table-wrap"><table><thead><tr><th>Nome</th><th>Email</th><th>Senha</th><th></th></tr></thead><tbody>';
    if(!d.rows.length) h+='<tr><td colspan="4" class="td-empty">Nenhum usuÃ¡rio</td></tr>';
    d.rows.forEach((r,ri)=>{
      h+=`<tr><td>${r[0]||'â€”'}</td><td>${r[1]||'â€”'}</td><td>â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</td>
      <td><button class="btn btn-danger btn-sm" onclick="excluirLinha('USUARIOS','usuarios',${ri+1})">âœ•</button></td></tr>`;
    });
    h+='</tbody></table></div></div>';
    el('pg-usuarios').innerHTML=h;
  } catch(e){ el('pg-usuarios').innerHTML=`<div class="loading-row" style="color:var(--red)">Erro: ${e.message}</div>`; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROVENTOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _pvDados = null;

async function loadProventos() {
  el('pg-proventos').innerHTML = loading();
  try {
    const d = await apiGet('getProventos');
    _pvDados = d;
    renderProventos(d);
  } catch(e) {
    el('pg-proventos').innerHTML = `<div class="loading-row" style="color:var(--red)">Erro: ${e.message}</div>`;
  }
}

function filtrarProventos(f) {
  _pvFiltro = f;
  document.querySelectorAll('.pv-filter-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.f === f);
  });
  if (_pvDados) renderProventos(_pvDados);
}

function renderProventos(d) {
  const { items, totais } = d;
  const maxAcum = Math.max(...(items.map(i => i.totalAcum)), 1);

  // KPIs de topo
  let h = `<div class="cards">
    <div class="kpi kpi-purple">
      <div class="kpi-label">Total Acumulado</div>
      <div class="kpi-value purple">${fmt(totais.acumulado)}</div>
      <div class="kpi-sub">Proventos recebidos</div>
    </div>
    <div class="kpi kpi-green">
      <div class="kpi-label">Estimativa Mensal</div>
      <div class="kpi-value green">${fmt(totais.mes)}</div>
      <div class="kpi-sub">Por mÃªs</div>
    </div>
    <div class="kpi kpi-cyan">
      <div class="kpi-label">Estimativa Anual</div>
      <div class="kpi-value cyan">${fmt(totais.ano)}</div>
      <div class="kpi-sub">Por ano</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Ativos com Provento</div>
      <div class="kpi-value amber">${items.length}</div>
      <div class="kpi-sub">cadastrados</div>
    </div>
  </div>`;

  // Filtros
  h += `<div class="pv-filter">
    <button class="pv-filter-btn ${_pvFiltro==='TODOS'?'active':''}" data-f="TODOS" onclick="filtrarProventos('TODOS')">Todos</button>
    <button class="pv-filter-btn ${_pvFiltro==='DIA'?'active':''}"   data-f="DIA"   onclick="filtrarProventos('DIA')">ğŸ’§ Por Dia</button>
    <button class="pv-filter-btn ${_pvFiltro==='PERC'?'active':''}"  data-f="PERC"  onclick="filtrarProventos('PERC')">ğŸ“Š Por %</button>
  </div>`;

  // GrÃ¡fico de barras (Estimativa Mensal por ativo)
  const itemsVisiveis = items.filter(i => _pvFiltro==='TODOS' || i.modo===_pvFiltro);

  if (itemsVisiveis.length) {
    const maxMes = Math.max(...itemsVisiveis.map(i => i.rendMes), 1);
    h += `<div class="chart-card" style="margin-bottom:20px">
      <div class="chart-head">
        <span class="chart-title">Estimativa Mensal por Ativo</span>
        <span style="font-size:10px;color:var(--muted)">R$/mÃªs</span>
      </div>
      <div class="chart-body">
        ${itemsVisiveis.map(i => {
          const barClass = i.modo==='DIA' ? 'bar bar-cyan' : 'bar bar-purple';
          return `<div class="${barClass}" style="height:${Math.max(4,Math.round(i.rendMes/maxMes*100))}%" data-tip="${i.ticker}: ${fmt(i.rendMes)}/mÃªs"></div>`;
        }).join('')}
      </div>
      <div class="chart-labels">${itemsVisiveis.map(i=>`<span>${i.ticker}</span>`).join('')}</div>
    </div>`;
  }

  // Lista de ativos
  if (!itemsVisiveis.length) {
    h += `<div class="tcard"><div style="text-align:center;padding:40px;color:var(--muted)">
      Nenhum provento cadastrado. Clique em "+ Novo Provento" para adicionar.
    </div></div>`;
  } else {
    h += itemsVisiveis.map((it, idx) => {
      const porcMax = it.totalAcum / maxAcum * 100;
      const badge   = it.modo === 'DIA'
        ? `<span class="badge badge-dia">ğŸ’§ R$/DIA</span>`
        : `<span class="badge badge-perc">ğŸ“Š % A.A.</span>`;
      const rendInfo = it.modo === 'DIA'
        ? `${fmt(it.valorDia)}/dia`
        : `${parseFloat(it.perc).toFixed(2)}% a.a. sobre ${fmt(it.valorInv)}`;

      // Encontrar o Ã­ndice real no array original
      const idxOriginal = items.indexOf(it);

      return `<div class="pv-card">
        <div style="min-width:0">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <div class="pv-ticker">${it.ticker}</div>
            ${badge}
            <span style="font-size:10px;color:var(--muted);font-family:'DM Mono'">${it.tipoAtivo}</span>
          </div>
          <div class="pv-meta">
            <span>ğŸ“… InÃ­cio: ${it.dataInicio}</span>
            <span>â± ${it.diasAcum} dias</span>
            <span style="color:var(--muted2)">${rendInfo}</span>
            ${it.tipoProvento ? `<span style="color:var(--cyan);font-size:10px">${it.tipoProvento}</span>` : ''}
          </div>
          ${it.obs ? `<div style="font-size:11px;color:var(--muted);margin-top:4px;font-style:italic">ğŸ“ ${it.obs}</div>` : ''}
          <div class="pv-bar-wrap"><div class="pv-bar-inner" style="width:${porcMax.toFixed(1)}%"></div></div>
          <div class="pv-actions">
            <button class="btn btn-blue btn-sm" onclick="editarProvento(${idxOriginal})">âœ Editar</button>
            <button class="btn btn-danger btn-sm" onclick="excluirProvento(${idxOriginal})">âœ• Excluir</button>
          </div>
        </div>
        <div class="pv-stats">
          <div>
            <div class="pv-stat-label">Acumulado</div>
            <div class="pv-stat-val purple">${fmt(it.totalAcum)}</div>
          </div>
          <div>
            <div class="pv-stat-label">MÃªs (est.)</div>
            <div class="pv-stat-val green">${fmt(it.rendMes)}</div>
          </div>
          <div>
            <div class="pv-stat-label">Ano (est.)</div>
            <div class="pv-stat-val cyan">${fmt(it.rendAno)}</div>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  el('pg-proventos').innerHTML = h;
}

// â”€â”€ Modal Proventos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _pvRowIdx = null;

function openProventoModal(rowIdx, rowData) {
  _pvRowIdx = rowIdx;
  const modo = rowData ? String(rowData[3]).toUpperCase() : 'DIA';

  el('modalTitle').textContent = rowIdx !== null ? 'Editar Provento' : 'Novo Provento';
  el('modalForm').innerHTML = `
    <div class="modo-toggle" style="margin-bottom:16px">
      <button class="modo-btn ${modo==='DIA'?'active':''}" id="modoBtnDia"  onclick="setModoProvento('DIA')">ğŸ’§ Valor por Dia (R$)</button>
      <button class="modo-btn ${modo==='PERC'?'active':''}" id="modoBtnPerc" onclick="setModoProvento('PERC')">ğŸ“Š Percentual (% a.a.)</button>
    </div>
    <input type="hidden" id="pvModo" value="${modo}"/>
    <div class="fgrid">
      <div class="fg"><label>Ticker</label><input id="pvTicker" type="text" placeholder="Ex: MXRF11" value="${rowData?rowData[0]:''}"/></div>
      <div class="fg"><label>Tipo de Ativo</label>
        <select id="pvTipoAtivo">
          <option ${rowData&&rowData[1]==='FII'?'selected':''}>FII</option>
          <option ${rowData&&rowData[1]==='AÃ‡ÃƒO'?'selected':''}>AÃ‡ÃƒO</option>
          <option ${rowData&&rowData[1]==='CDB'?'selected':''}>CDB</option>
          <option ${rowData&&rowData[1]==='LCI'?'selected':''}>LCI</option>
          <option ${rowData&&rowData[1]==='LCA'?'selected':''}>LCA</option>
        </select>
      </div>
      <div class="fg"><label>Tipo de Provento</label>
        <select id="pvTipoProvento">
          <option ${rowData&&rowData[2]==='Dividendo'?'selected':''}>Dividendo</option>
          <option ${rowData&&rowData[2]==='JCP'?'selected':''}>JCP</option>
          <option ${rowData&&rowData[2]==='Rendimento'?'selected':''}>Rendimento</option>
          <option ${rowData&&rowData[2]==='AmortizaÃ§Ã£o'?'selected':''}>AmortizaÃ§Ã£o</option>
          <option ${rowData&&rowData[2]==='Outros'?'selected':''}>Outros</option>
        </select>
      </div>
      <div class="fg"><label>Data InÃ­cio</label><input id="pvDataInicio" type="date" value="${rowData&&rowData[7]?isoDate(rowData[7]):today()}"/></div>
      
      <div class="fg modo-dia" id="fgValorDia" style="display:${modo==='DIA'?'flex':'none'}"><label>Valor por Dia (R$)</label><input id="pvValorDia" type="number" step="0.01" min="0" placeholder="0.00" value="${rowData?rowData[4]:''}"/></div>
      <div class="fg modo-perc" id="fgPerc" style="display:${modo==='PERC'?'flex':'none'}"><label>Percentual Anual (%)</label><input id="pvPerc" type="number" step="0.01" min="0" placeholder="Ex: 12.5" value="${rowData?rowData[5]:''}"/></div>
      <div class="fg modo-perc" id="fgValorInv" style="display:${modo==='PERC'?'flex':'none'}"><label>Valor Investido (R$)</label><input id="pvValorInv" type="number" step="0.01" min="0" placeholder="0.00" value="${rowData?rowData[6]:''}"/></div>
      
      <div class="fg full"><label>ObservaÃ§Ã£o (opcional)</label><input id="pvObs" type="text" placeholder="Ex: Provento mensal" value="${rowData?String(rowData[11]||''):''}"/></div>
    </div>`;
  el('overlay').classList.add('open');
}

function setModoProvento(modo) {
  document.getElementById('pvModo').value = modo;
  document.getElementById('modoBtnDia').classList.toggle('active',  modo==='DIA');
  document.getElementById('modoBtnPerc').classList.toggle('active', modo==='PERC');
  document.getElementById('fgValorDia').style.display  = modo==='DIA'  ? 'flex' : 'none';
  document.getElementById('fgPerc').style.display      = modo==='PERC' ? 'flex' : 'none';
  document.getElementById('fgValorInv').style.display  = modo==='PERC' ? 'flex' : 'none';
}

function today() {
  return new Date().toISOString().slice(0,10);
}
function isoDate(str) {
  // Tenta converter dd/MM/yyyy ou similar para yyyy-MM-dd
  if (!str) return today();
  if (/^\d{4}-\d{2}-\d{2}/.test(str)) return str.slice(0,10);
  const parts = String(str).split(/[\/\-\.]/);
  if (parts.length === 3 && parts[0].length === 2) return `${parts[2]}-${parts[1]}-${parts[0]}`;
  return today();
}

async function editarProvento(idx) {
  try {
    const d   = await apiGet('lerAba', { aba: 'PROVENTOS' });
    const row = d.rows[idx];
    if (!row) { toast('Linha nÃ£o encontrada','err'); return; }
    openProventoModal(idx, row);
  } catch(e) { toast('Erro: '+e.message,'err'); }
}

async function excluirProvento(idx) {
  if (!confirm('Excluir este provento?')) return;
  try {
    await apiWrite('deletarLinha', { aba:'PROVENTOS', rowIndex: idx });
    toast('Provento excluÃ­do!','ok');
    loadProventos();
  } catch(e) { toast('Erro: '+e.message,'err'); }
}

// â”€â”€ Salvar provento (sobrescreve saveModal para PROVENTOS) â”€â”€â”€
let _mAba, _mPg, _mRow, _mData, _mTipo;

async function saveModal() {
  // Se for modal de provento, delega
  if (_mTipo === 'PROVENTO') {
    await saveProvento();
    return;
  }
  // Modal genÃ©rico
  const fKey = _mTipo==='FII'?'FII':_mTipo==='ACAO'?'ACAO':_mTipo==='APORTE'?'APORTE':_mTipo==='USR'?'USR':'CDB_FORM';
  const fields = FORMS[fKey] || [];
  const raw = fields.map(f => el('mf_'+f.id)?.value || '');
  let linha;
  const agora = new Date().toLocaleString('pt-BR');
  const n = v => parseFloat(v)||0;
  const fix = (v,d=2) => (+(+parseFloat(v).toFixed(d)))||0;
  if (_mTipo==='FII'||_mTipo==='CDB_FORM') {
    const[ticker,tipo,qtd,pm,pa,dy,ultDY]=raw;
    const vi=fix(n(qtd)*n(pm));const va=fix(n(qtd)*n(pa));
    const ret=n(pm)>0?fix((n(pa)-n(pm))/n(pm)*100):0;
    linha=[ticker,tipo,qtd,pm,pa,vi,va,ret,dy,ultDY,agora];
  } else if (_mTipo==='ACAO') {
    const[ticker,setor,qtd,pm,pa,pl]=raw;
    const vi=fix(n(qtd)*n(pm));const va=fix(n(qtd)*n(pa));
    const ret=n(pm)>0?fix((n(pa)-n(pm))/n(pm)*100):0;
    linha=[ticker,setor,qtd,pm,pa,vi,va,ret,pl,agora];
  } else if (_mTipo==='APORTE') {
    const[data,ticker,tipo,qtd,preco,corretora,obs]=raw;
    linha=[data,ticker,tipo,qtd,preco,fix(n(qtd)*n(preco)),corretora,obs];
  } else {
    linha=raw;
  }
  try {
    if (_mRow!==null) {
      await apiWrite('atualizarLinha',{aba:_mAba,rowIndex:_mRow,linha});
      toast('Atualizado!','ok');
    } else {
      await apiWrite('adicionarLinha',{aba:_mAba,linha});
      toast('Adicionado!','ok');
    }
    closeModal();
    if (_mAba==='USUARIOS') loadUsuarios(); else loadTabela(_mAba,_mPg);
  } catch(e){ toast('Erro: '+e.message,'err'); }
}

async function saveProvento() {
  const modo       = el('pvModo')?.value || 'DIA';
  const ticker     = el('pvTicker')?.value?.trim().toUpperCase() || '';
  const tipoAtivo  = el('pvTipoAtivo')?.value || '';
  const tipoProv   = el('pvTipoProvento')?.value || '';
  const valorDia   = parseFloat(el('pvValorDia')?.value || '0') || 0;
  const perc       = parseFloat(el('pvPerc')?.value || '0') || 0;
  const valorInv   = parseFloat(el('pvValorInv')?.value || '0') || 0;
  const dataInicio = el('pvDataInicio')?.value || today();
  const obs        = el('pvObs')?.value || '';

  if (!ticker) { toast('Informe o Ticker','err'); return; }

  // Calcula acumulado inicial
  const dtInicio = new Date(dataInicio);
  const diasAcum = Math.max(0, Math.floor((new Date() - dtInicio) / (1000*60*60*24)));
  let totalAcum  = 0;
  if (modo === 'DIA') totalAcum = +(valorDia * diasAcum).toFixed(2);
  else totalAcum = +((perc/100) * valorInv * (diasAcum/365)).toFixed(2);

  const agora = new Date().toLocaleString('pt-BR');
  // Colunas: Ticker,TipoAtivo,TipoProvento,Modo,Valor/Dia,Perc,ValorInv,DataInicio,DiasAcum,TotalAcum,UltimoReg,Obs
  const linha = [ticker, tipoAtivo, tipoProv, modo, valorDia, perc, valorInv, dataInicio, diasAcum, totalAcum, agora, obs];

  try {
    if (_pvRowIdx !== null) {
      await apiWrite('atualizarLinha', { aba:'PROVENTOS', rowIndex:_pvRowIdx, linha });
      toast('Provento atualizado!','ok');
    } else {
      await apiWrite('adicionarLinha', { aba:'PROVENTOS', linha });
      toast('Provento adicionado!','ok');
    }
    closeModal();
    loadProventos();
  } catch(e) { toast('Erro: '+e.message,'err'); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL GENÃ‰RICO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FORMS = {
  FII:[
    {id:'ticker',label:'Ticker',type:'text'},{id:'tipo',label:'Tipo',type:'text'},
    {id:'qtd',label:'Quantidade',type:'number'},{id:'pm',label:'PreÃ§o MÃ©dio/Alvo',type:'number',step:'0.01'},
    {id:'pa',label:'PreÃ§o Atual',type:'number',step:'0.01'},
    {id:'dy',label:'DY %',type:'number',step:'0.01'},{id:'ultDY',label:'Ãšltimo DY (R$)',type:'number',step:'0.01'},
  ],
  ACAO:[
    {id:'ticker',label:'Ticker',type:'text'},{id:'setor',label:'Setor',type:'text'},
    {id:'qtd',label:'Quantidade',type:'number'},{id:'pm',label:'PreÃ§o MÃ©dio/Alvo',type:'number',step:'0.01'},
    {id:'pa',label:'PreÃ§o Atual',type:'number',step:'0.01'},
    {id:'pl',label:'P/L',type:'number',step:'0.01'},
  ],
  CDB_FORM:[
    {id:'ticker',label:'Ticker/Nome',type:'text'},{id:'tipo',label:'Tipo (CDB/LCI/LCA)',type:'text'},
    {id:'qtd',label:'Quantidade',type:'number'},{id:'pm',label:'PreÃ§o MÃ©dio',type:'number',step:'0.01'},
    {id:'pa',label:'PreÃ§o Atual',type:'number',step:'0.01'},
    {id:'dy',label:'DY %',type:'number',step:'0.01'},{id:'ultDY',label:'Ãšltimo DY (R$)',type:'number',step:'0.01'},
  ],
  APORTE:[
    {id:'data',label:'Data',type:'date',full:true},{id:'ticker',label:'Ticker',type:'text'},
    {id:'tipo',label:'Tipo (FII/AÃ‡ÃƒO/CDB)',type:'text'},{id:'qtd',label:'Quantidade',type:'number'},
    {id:'preco',label:'PreÃ§o (R$)',type:'number',step:'0.01'},{id:'corretora',label:'Corretora',type:'text'},
    {id:'obs',label:'ObservaÃ§Ã£o',type:'text',full:true},
  ],
  USR:[
    {id:'nome',label:'Nome completo',type:'text',full:true},
    {id:'email',label:'Email',type:'email'},{id:'senha',label:'Senha',type:'password'},
  ],
};

function openModal(aba, pg, rowIdx, rowData, tipo) {
  _mAba=aba; _mPg=pg; _mRow=rowIdx; _mData=rowData; _mTipo=tipo;

  // Provento tem modal prÃ³prio
  if (tipo === 'PROVENTO') { openProventoModal(rowIdx, rowData); return; }

  const fKey   = tipo==='FII'?'FII':tipo==='ACAO'?'ACAO':tipo==='APORTE'?'APORTE':tipo==='USR'?'USR':'CDB_FORM';
  const fields = FORMS[fKey] || [];
  el('modalTitle').textContent = rowIdx!==null ? 'Editar' : 'Novo';
  let h = '<div class="fgrid">';
  fields.forEach((f,i) => {
    const v = (rowData&&rowData[i]!==undefined) ? rowData[i] : '';
    h+=`<div class="fg ${f.full?'full':''}"><label>${f.label}</label>
      <input id="mf_${f.id}" type="${f.type}" value="${String(v).replace(/"/g,'&quot;')}" placeholder="${f.label}" ${f.step?`step="${f.step}"`:''}/>
    </div>`;
  });
  h+='</div>';
  el('modalForm').innerHTML = h;
  el('overlay').classList.add('open');
}

async function editarLinha(aba, pg, ri) {
  try{
    const d   = await apiGet('lerAba', { aba });
    const row = d.rows[ri];
    const tipo= aba.includes('FIIS')?'FII':aba.includes('ACOES')?'ACAO':aba==='APORTES'?'APORTE':aba==='USUARIOS'?'USR':'CDB_FORM';
    openModal(aba, pg, ri+1, row, tipo);
  }catch(e){ toast('Erro: '+e.message,'err'); }
}
async function excluirLinha(aba, pg, rowIndex) {
  if(!confirm('Excluir este registro?')) return;
  try{
    await apiWrite('deletarLinha', { aba, rowIndex });
    toast('ExcluÃ­do!','ok');
    if(aba==='USUARIOS') loadUsuarios(); else loadTabela(aba, pg);
  }catch(e){ toast('Erro: '+e.message,'err'); }
}
function closeModal(){ el('overlay').classList.remove('open'); _mTipo=null; }
function closeModalOutside(e){ if(e.target===el('overlay')) closeModal(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function el(id){ return document.getElementById(id); }
function setErr(id, msg){ el(id).textContent = msg; }
function loading(){ return '<div class="loading-row"><span class="spin"></span> Carregando...</div>'; }
function toast(msg, type='info'){
  const t=el('toast'), ico=el('toastIco'), txt=el('toastMsg');
  txt.textContent=msg;
  ico.textContent=type==='ok'?'âœ“':type==='err'?'âœ•':'â„¹';
  t.className='show '+type;
  clearTimeout(window._tt);
  window._tt=setTimeout(()=>t.className='',3500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function boot(){
  initTheme();
  const url = localStorage.getItem(LS_URL);
  if (url) {
    API = url;
    el('cfgBanner').style.display = 'none';
    const usr = localStorage.getItem(LS_USR);
    if (usr) {
      try {
        currentUser = JSON.parse(usr);
        el('sbNome').textContent  = currentUser.nome;
        el('sbEmail').textContent = currentUser.email;
        el('app').classList.add('show');
        carregarPagina('dashboard');
        return;
      } catch(_) {}
    }
    el('loginScreen').classList.add('show');
  }
  document.addEventListener('keyup', e => {
    if (e.key==='Enter' && el('loginScreen').classList.contains('show')) fazerLogin();
    if (e.key==='Escape') { closeModal(); closeSidebar(); }
  });
})();
</script>
</body>
</html>
