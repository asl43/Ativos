<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Sistema Ativos</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#07080d;--surface:#0e0f18;--card:#12131f;--card2:#181929;
  --border:#1e2035;--border2:#252640;
  --amber:#f59e0b;--amber-dim:#78501a;--amber-glow:rgba(245,158,11,.12);
  --green:#22c55e;--red:#ef4444;--blue:#3b82f6;--cyan:#06b6d4;
  --text:#e2e4f0;--muted:#565870;--muted2:#3a3c55;
  --r:10px;--r2:16px;--shadow:0 4px 24px rgba(0,0,0,.3);
}
[data-theme="light"]{
  --bg:#f8f9fc;--surface:#ffffff;--card:#ffffff;--card2:#f1f3f9;
  --border:#e5e7f0;--border2:#d8dae5;
  --amber:#d97706;--amber-dim:#fcd34d;--amber-glow:rgba(217,119,6,.08);
  --green:#16a34a;--red:#dc2626;--blue:#2563eb;--cyan:#0891b2;
  --text:#1e2035;--muted:#646882;--muted2:#8a8fa8;
  --shadow:0 4px 24px rgba(30,32,53,.08);
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;font-size:14px;transition:background .3s,color .3s}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--amber)}

/* â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfgBanner{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:20px}
.cfg-box{width:100%;max-width:520px;background:var(--card);border:1px solid var(--border2);border-radius:var(--r2);padding:40px;box-shadow:var(--shadow)}
.cfg-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:32px;color:var(--amber);letter-spacing:2px;margin-bottom:4px}
.cfg-desc{color:var(--muted);font-size:13px;margin-bottom:28px;line-height:1.6}
.cfg-label{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600;margin-bottom:6px}
.cfg-input{width:100%;padding:12px 14px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);color:var(--text);font-size:13px;outline:none;transition:.2s;margin-bottom:16px;font-family:'DM Mono',monospace}
.cfg-input:focus{border-color:var(--amber);box-shadow:0 0 0 3px var(--amber-glow)}
.cfg-note{font-size:12px;color:var(--muted);margin-bottom:24px;line-height:1.7;background:var(--surface);padding:14px;border-radius:var(--r);border:1px solid var(--border)}
.cfg-note code{background:rgba(245,158,11,.15);color:var(--amber);padding:2px 6px;border-radius:4px;font-family:'DM Mono',monospace;font-size:11px}
.btn-cfg{width:100%;padding:14px;background:var(--amber);color:#fff;border:none;border-radius:var(--r);font-weight:700;font-size:14px;cursor:pointer;font-family:'Outfit',sans-serif;letter-spacing:.5px;transition:.2s}
.btn-cfg:hover{background:#d97706;transform:translateY(-1px)}
.cfg-err{color:var(--red);font-size:12px;margin-top:10px;min-height:18px;font-family:'DM Mono',monospace}
.cfg-ok{color:var(--green);font-size:12px;margin-top:10px;min-height:18px}

/* â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loginScreen{position:fixed;inset:0;z-index:900;background:var(--bg);display:none;align-items:center;justify-content:center;padding:20px}
#loginScreen.show{display:flex}
.login-wrap{width:100%;max-width:400px;background:var(--card);border:1px solid var(--border2);border-radius:var(--r2);padding:44px 40px;text-align:center;box-shadow:var(--shadow)}
.login-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:40px;color:var(--amber);letter-spacing:3px}
.login-tagline{color:var(--muted);font-size:12px;letter-spacing:2px;text-transform:uppercase;margin-bottom:36px;margin-top:4px}
.field{width:100%;padding:13px 14px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);color:var(--text);font-size:14px;outline:none;transition:.2s;font-family:'Outfit',sans-serif;margin-bottom:12px}
.field:focus{border-color:var(--amber);box-shadow:0 0 0 3px var(--amber-glow)}
.btn-login{width:100%;padding:14px;background:var(--amber);color:#fff;border:none;border-radius:var(--r);font-weight:700;font-size:15px;cursor:pointer;font-family:'Outfit',sans-serif;transition:.2s;letter-spacing:.5px;margin-top:4px}
.btn-login:hover{background:#d97706;transform:translateY(-1px)}
.login-err{color:var(--red);font-size:12px;margin-top:12px;min-height:18px;font-family:'DM Mono',monospace}
.login-info{color:var(--muted);font-size:11px;margin-top:8px;font-family:'DM Mono',monospace}
.spin-wrap{display:none;color:var(--muted);font-size:13px;margin-top:10px}
.spin{display:inline-block;width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--amber);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:none;height:100vh;flex-direction:row}
#app.show{display:flex}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar{width:240px;min-width:240px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;overflow-y:auto;flex-shrink:0;transition:width .25s}
.sb-top{padding:24px 20px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.sb-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:24px;color:var(--amber);letter-spacing:1px;white-space:nowrap}
.sb-user{flex:1;min-width:0}
.sb-user-name{font-size:13px;color:var(--text);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-user-email{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-nav{flex:1;padding:12px 0;overflow-y:auto}
.sb-section{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted2);padding:16px 20px 6px;font-weight:600}
.sb-link{display:flex;align-items:center;gap:12px;padding:10px 20px;cursor:pointer;color:var(--muted);font-size:13px;font-weight:500;transition:.15s;border-left:3px solid transparent;user-select:none;border-radius:0 8px 8px 0;margin:0 4px}
.sb-link:hover{color:var(--text);background:rgba(245,158,11,.06)}
.sb-link.active{color:var(--amber);background:var(--amber-glow);border-left-color:var(--amber)}
.sb-link .ico{width:20px;text-align:center;font-size:15px;flex-shrink:0}
.sb-bottom{padding:16px 20px;border-top:1px solid var(--border)}
.btn-out{width:100%;padding:10px;background:transparent;border:1px solid var(--border2);color:var(--muted);border-radius:var(--r);cursor:pointer;font-size:12px;font-family:'Outfit',sans-serif;transition:.2s;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-out:hover{border-color:var(--red);color:var(--red);background:rgba(239,68,68,.06)}

/* â”€â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#topbar{padding:14px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--card);flex-shrink:0;gap:12px}
.tb-title{font-family:'Syne',sans-serif;font-weight:700;font-size:18px;color:var(--text)}
.tb-sub{font-size:12px;color:var(--muted);margin-top:2px}
.tb-acts{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
#themeToggle{padding:8px 12px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);color:var(--text);cursor:pointer;font-size:12px;transition:.2s;display:flex;align-items:center;gap:6px}
#themeToggle:hover{border-color:var(--amber);color:var(--amber)}
#content{flex:1;overflow-y:auto;padding:24px}
.page{display:none;animation:fadeIn .2s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€â”€ BOTÃ•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{padding:9px 18px;border-radius:var(--r);font-size:12px;font-weight:600;cursor:pointer;border:none;transition:.2s;font-family:'Outfit',sans-serif;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
.btn-primary{background:var(--amber);color:#fff}
.btn-primary:hover{background:#d97706;transform:translateY(-1px)}
.btn-ghost{background:var(--surface);color:var(--text);border:1px solid var(--border2)}
.btn-ghost:hover{border-color:var(--amber);color:var(--amber)}
.btn-danger{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)}
.btn-danger:hover{background:rgba(239,68,68,.2)}
.btn-blue{background:rgba(59,130,246,.1);color:var(--blue);border:1px solid rgba(59,130,246,.2)}
.btn-blue:hover{background:rgba(59,130,246,.2)}
.btn-sm{padding:6px 12px;font-size:11px}

/* â”€â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:20px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s}
.kpi:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.kpi::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--amber),transparent)}
.kpi-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600;margin-bottom:10px}
.kpi-value{font-family:'Syne',sans-serif;font-size:24px;font-weight:700;color:var(--text);line-height:1.1}
.kpi-value.amber{color:var(--amber)}.kpi-value.green{color:var(--green)}.kpi-value.red{color:var(--red)}.kpi-value.blue{color:var(--blue)}
.kpi-sub{font-size:11px;color:var(--muted);margin-top:6px}

/* â”€â”€â”€ CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:20px;margin-bottom:22px}
.chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.chart-title{font-weight:600;font-size:14px}
.chart-body{display:flex;align-items:flex-end;gap:8px;height:120px;padding:8px 0}
.bar{flex:1;min-width:28px;border-radius:6px 6px 0 0;position:relative;background:linear-gradient(180deg,var(--amber) 0%,var(--amber-dim) 100%);transition:.3s;cursor:default}
.bar:hover{filter:brightness(1.1)}
.bar:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid var(--border2);padding:6px 10px;border-radius:8px;font-size:11px;color:var(--amber);white-space:nowrap;pointer-events:none;font-family:'DM Mono',monospace;z-index:10;box-shadow:var(--shadow)}
.chart-labels{display:flex;gap:8px;margin-top:8px}
.chart-labels span{flex:1;text-align:center;font-size:9px;color:var(--muted);font-family:'DM Mono',monospace;overflow:hidden;text-overflow:ellipsis}

/* â”€â”€â”€ TABELA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tcard{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;margin-bottom:18px}
.tcard-head{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:10px}
.tcard-title{font-weight:600;font-size:14px}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;min-width:600px}
thead th{padding:12px 14px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600;background:var(--surface);white-space:nowrap;position:sticky;top:0;z-index:1}
tbody tr{border-top:1px solid var(--border);transition:.15s}
tbody tr:hover{background:rgba(245,158,11,.04)}
tbody td{padding:12px 14px;color:var(--text);white-space:nowrap;vertical-align:middle}
.td-ticker{font-family:'DM Mono',monospace;font-weight:500;color:var(--amber);font-size:13px}
.td-pos{color:var(--green);font-weight:600;font-family:'DM Mono',monospace}
.td-neg{color:var(--red);font-weight:600;font-family:'DM Mono',monospace}
.td-num{font-family:'DM Mono',monospace}
.td-empty{text-align:center;color:var(--muted);padding:40px!important}
.td-acts{display:flex;gap:6px}
.loading-row{text-align:center;padding:44px;color:var(--muted)}

/* â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(7,8,13,.7);z-index:800;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
[data-theme="light"] .overlay{background:rgba(30,32,53,.5)}
.overlay.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border2);border-radius:var(--r2);padding:28px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);animation:modalIn .2s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
.modal-title{font-family:'Syne',sans-serif;font-weight:700;font-size:22px;color:var(--amber);margin-bottom:24px;letter-spacing:1px}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.fg{display:flex;flex-direction:column;gap:6px}
.fg.full{grid-column:span 2}
.fg label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600}
.fg input,.fg select,.fg textarea{padding:11px 12px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);color:var(--text);font-size:13px;outline:none;transition:.2s;font-family:'Outfit',sans-serif}
.fg input:focus{border-color:var(--amber);box-shadow:0 0 0 3px var(--amber-glow)}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px;flex-wrap:wrap}
.btn-cancel{padding:10px 20px;background:transparent;border:1px solid var(--border2);color:var(--muted);border-radius:var(--r);cursor:pointer;font-size:13px;font-family:'Outfit',sans-serif;transition:.2s}
.btn-cancel:hover{color:var(--text);border-color:var(--muted)}
.btn-save{padding:10px 24px;background:var(--amber);color:#fff;border:none;border-radius:var(--r);font-weight:700;font-size:13px;cursor:pointer;font-family:'Outfit',sans-serif}
.btn-save:hover{background:#d97706}

/* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast{position:fixed;bottom:24px;right:24px;z-index:9999;background:var(--card2);border:1px solid var(--border2);border-radius:var(--r2);padding:14px 20px;font-size:13px;pointer-events:none;transform:translateY(16px);opacity:0;transition:.25s;max-width:340px;box-shadow:var(--shadow);display:flex;align-items:center;gap:10px}
#toast.show{transform:translateY(0);opacity:1}
#toast.ok{border-color:var(--green);color:var(--green)}
#toast.err{border-color:var(--red);color:var(--red)}
#toast.info{border-color:var(--amber);color:var(--amber)}
.toast-ico{font-size:18px}

/* â”€â”€â”€ RESPONSIVO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:1024px){
  #sidebar{width:72px;min-width:72px}
  .sb-logo,.sb-user-name,.sb-user-email,.sb-section,.sb-link span:not(.ico),.sb-bottom .btn-out span{display:none}
  .sb-link{justify-content:center;padding:12px}
  .sb-top{padding:20px 12px;justify-content:center}
}
@media(max-width:600px){
  #sidebar{position:fixed;left:0;top:0;bottom:0;z-index:700;transform:translateX(-100%);transition:transform .25s}
  #sidebar.open{transform:translateX(0)}
  .sb-logo{display:block}
  .sb-user-name,.sb-user-email,.sb-section,.sb-link span:not(.ico){display:block}
  .sb-link{justify-content:flex-start;padding:10px 20px}
  #menuToggle{display:flex}
  .cards{grid-template-columns:1fr 1fr}
  .fgrid{grid-template-columns:1fr}
  .fg.full{grid-column:span 1}
  #content{padding:16px}
  #topbar{padding:12px 16px}
  .tb-title{font-size:16px}
}
#menuToggle{display:none;padding:8px 12px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);color:var(--text);cursor:pointer;font-size:14px}
</style>
</head>
<body>

<!-- â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="cfgBanner">
  <div class="cfg-box">
    <div class="cfg-logo">âš™ CONFIGURAR API</div>
    <div class="cfg-desc" style="margin-top:6px">
      Cole abaixo a URL do <strong style="color:var(--text)">Apps Script Web App</strong> implantado na sua planilha SISTEMA ATIVOS.
    </div>
    <div class="cfg-label">URL do Web App</div>
    <input class="cfg-input" id="cfgUrl" type="url" placeholder="https://script.google.com/macros/s/XXXXXX/exec"/>
    <div class="cfg-note">
      <strong style="color:var(--text)">Como obter a URL:</strong><br>
      1. Planilha â†’ <code>ExtensÃµes</code> â†’ <code>Apps Script</code><br>
      2. Cole o <code>Code.gs</code> fornecido<br>
      3. Execute <code>inicializarPlanilha()</code> e <code>criarTriggers()</code><br>
      4. <code>Implantar</code> â†’ <code>Nova implantaÃ§Ã£o</code> â†’ Tipo: <code>Aplicativo da Web</code><br>
      5. Executar como: <code>Eu</code> | Acesso: <code>Qualquer pessoa</code><br>
      6. Copie e cole a URL aqui
    </div>
    <button class="btn-cfg" onclick="salvarConfig()">TESTAR E CONECTAR</button>
    <div class="cfg-err" id="cfgErr"></div>
    <div class="cfg-ok"  id="cfgOk"></div>
  </div>
</div>

<!-- â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loginScreen">
  <div class="login-wrap">
    <div class="login-logo">ATIVOS</div>
    <div class="login-tagline">GestÃ£o de Investimentos</div>
    <input class="field" id="lEmail" type="email" placeholder="Email (cadastrado na aba UsuÃ¡rios)"/>
    <input class="field" id="lSenha" type="password" placeholder="Senha"/>
    <button class="btn-login" onclick="fazerLogin()">ENTRAR</button>
    <div class="spin-wrap" id="lSpin"><span class="spin"></span>Verificando...</div>
    <div class="login-err" id="lErr"></div>
    <div class="login-info" id="lInfo"></div>
    <div style="margin-top:18px;font-size:11px">
      <a href="#" onclick="resetConfig()" style="color:var(--muted2);text-decoration:none">â†© Trocar URL da API</a>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app">
  <div id="sidebar">
    <div class="sb-top">
      <div class="sb-logo">âš¡ ATIVOS</div>
      <div class="sb-user">
        <div class="sb-user-name" id="sbNome">â€”</div>
        <div class="sb-user-email" id="sbEmail">â€”</div>
      </div>
    </div>
    <nav class="sb-nav">
      <div class="sb-section">Principal</div>
      <div class="sb-link active" onclick="nav(this,'dashboard')"><span class="ico">â—‰</span><span>Dashboard</span></div>
      <div class="sb-section">Renda Fixa</div>
      <div class="sb-link" onclick="nav(this,'cdb')"><span class="ico">ğŸ¦</span><span>CDB</span></div>
      <div class="sb-section">FIIs</div>
      <div class="sb-link" onclick="nav(this,'fiisC')"><span class="ico">ğŸ¢</span><span>FIIs Comprados</span></div>
      <div class="sb-link" onclick="nav(this,'fiisN')"><span class="ico">ğŸ‘</span><span>FIIs Watchlist</span></div>
      <div class="sb-section">AÃ§Ãµes</div>
      <div class="sb-link" onclick="nav(this,'acC')"><span class="ico">ğŸ“ˆ</span><span>AÃ§Ãµes Compradas</span></div>
      <div class="sb-link" onclick="nav(this,'acN')"><span class="ico">ğŸ”</span><span>AÃ§Ãµes Watchlist</span></div>
      <div class="sb-section">GestÃ£o</div>
      <div class="sb-link" onclick="nav(this,'aportes')"><span class="ico">ğŸ’°</span><span>Aportes</span></div>
      <div class="sb-link" onclick="nav(this,'historico')"><span class="ico">ğŸ“…</span><span>HistÃ³rico</span></div>
      <div class="sb-link" onclick="nav(this,'usuarios')"><span class="ico">ğŸ‘¤</span><span>UsuÃ¡rios</span></div>
    </nav>
    <div class="sb-bottom">
      <button class="btn-out" onclick="logout()"><span>â»</span><span>Sair</span></button>
    </div>
  </div>

  <div id="main">
    <div id="topbar">
      <div style="display:flex;align-items:center;gap:12px">
        <button id="menuToggle" onclick="toggleSidebar()">â˜°</button>
        <div>
          <div class="tb-title" id="tbTitle">Dashboard</div>
          <div class="tb-sub"  id="tbSub">VisÃ£o geral em tempo real</div>
        </div>
      </div>
      <div class="tb-acts" id="tbActs"></div>
      <button id="themeToggle" onclick="toggleTheme()">ğŸŒ™ Tema</button>
    </div>
    <div id="content">
      <div class="page active" id="pg-dashboard"></div>
      <div class="page" id="pg-cdb"></div>
      <div class="page" id="pg-fiisC"></div>
      <div class="page" id="pg-fiisN"></div>
      <div class="page" id="pg-acC"></div>
      <div class="page" id="pg-acN"></div>
      <div class="page" id="pg-aportes"></div>
      <div class="page" id="pg-historico"></div>
      <div class="page" id="pg-usuarios"></div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay" id="overlay" onclick="closeModalOutside(event)">
  <div class="modal" id="modalBox">
    <div class="modal-title" id="modalTitle">Novo Registro</div>
    <div id="modalForm"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn-save"   onclick="saveModal()">Salvar</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast"><span class="toast-ico" id="toastIco">â„¹</span><span id="toastMsg"></span></div>

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG & THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let API = '';
const LS_URL = 'siativos_url';
const LS_USR = 'siativos_usr';
const LS_THEME = 'siativos_theme';

// Theme toggle
function toggleTheme(){
  const html=document.documentElement;
  const current=html.getAttribute('data-theme')||'dark';
  const next=current==='dark'?'light':'dark';
  html.setAttribute('data-theme',next);
  localStorage.setItem(LS_THEME,next);
  document.getElementById('themeToggle').textContent=next==='dark'?'ğŸŒ™ Tema':'â˜€ï¸ Tema';
}
function initTheme(){
  const saved=localStorage.getItem(LS_THEME)||'dark';
  document.documentElement.setAttribute('data-theme',saved);
  document.getElementById('themeToggle').textContent=saved==='dark'?'ğŸŒ™ Tema':'â˜€ï¸ Tema';
}

// API calls - unchanged logic
async function apiGet(action, params = {}) {
  const qs = new URLSearchParams({ action, ...params }).toString();
  const url = `${API}?${qs}`;
  const r = await fetch(url, { method: 'GET', redirect: 'follow' });
  const txt = await r.text();
  let d;
  try { d = JSON.parse(txt); } catch(_) { throw new Error('Resposta invÃ¡lida: ' + txt.slice(0,200)); }
  if (d.error) throw new Error(d.error);
  return d;
}
async function apiWrite(action, params = {}) {
  const p = { ...params };
  if (p.linha && Array.isArray(p.linha)) p.linha = JSON.stringify(p.linha);
  return apiGet(action, p);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function salvarConfig() {
  const url = document.getElementById('cfgUrl').value.trim();
  if (!url.startsWith('https://script.google.com')) {
    setErr('cfgErr','URL invÃ¡lida. Deve comeÃ§ar com https://script.google.com');
    return;
  }
  setErr('cfgErr','â³ Testando conexÃ£o...');
  document.getElementById('cfgOk').textContent = '';
  try {
    const r = await fetch(`${url}?action=ping`, { method:'GET', redirect:'follow' });
    const t = await r.text();
    const d = JSON.parse(t);
    if (d.ok) {
      localStorage.setItem(LS_URL, url);
      API = url;
      setErr('cfgErr','');
      document.getElementById('cfgBanner').style.display = 'none';
      document.getElementById('loginScreen').classList.add('show');
      toast('API conectada com sucesso!','ok');
    } else {
      setErr('cfgErr','Resposta inesperada: ' + JSON.stringify(d));
    }
  } catch(e) {
    setErr('cfgErr','Erro: ' + e.message + '\n\nVerifique: 1) URL correta 2) ImplantaÃ§Ã£o com acesso "Qualquer pessoa"');
  }
}
function resetConfig() {
  localStorage.removeItem(LS_URL);
  localStorage.removeItem(LS_USR);
  location.reload();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentUser = null;
async function fazerLogin() {
  const email = document.getElementById('lEmail').value.trim();
  const senha = document.getElementById('lSenha').value.trim();
  if (!email || !senha) { setErr('lErr','Preencha email e senha.'); return; }
  setErr('lErr','');
  document.getElementById('lInfo').textContent = '';
  document.getElementById('lSpin').style.display = 'block';
  document.getElementById('lInfo').textContent = `Verificando: ${email}`;
  try {
    const res = await apiGet('autenticar', { email, senha });
    document.getElementById('lSpin').style.display = 'none';
    if (res.ok) {
      currentUser = res;
      localStorage.setItem(LS_USR, JSON.stringify(res));
      document.getElementById('loginScreen').classList.remove('show');
      document.getElementById('app').classList.add('show');
      document.getElementById('sbNome').textContent  = res.nome;
      document.getElementById('sbEmail').textContent = res.email;
      carregarPagina('dashboard');
    } else {
      setErr('lErr', res.msg || 'Acesso negado.');
      document.getElementById('lInfo').textContent = 'Verifique email/senha na aba "UsuÃ¡rios" da planilha.';
    }
  } catch(e) {
    document.getElementById('lSpin').style.display = 'none';
    setErr('lErr', 'Erro de comunicaÃ§Ã£o: ' + e.message);
  }
}
function logout() {
  currentUser = null;
  localStorage.removeItem(LS_USR);
  document.getElementById('app').classList.remove('show');
  document.getElementById('loginScreen').classList.add('show');
  document.getElementById('lEmail').value = '';
  document.getElementById('lSenha').value = '';
  setErr('lErr','');
  document.getElementById('lInfo').textContent = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVEGAÃ‡ÃƒO & UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PAGES = {
  dashboard: { title:'Dashboard',       sub:'VisÃ£o geral em tempo real',        load:loadDashboard,                           acts:dashActs },
  cdb:       { title:'CDB',             sub:'Renda fixa e tÃ­tulos',             load:()=>loadTabela('CDB','cdb'),             acts:()=>tableActs('CDB','cdb','CDB_FORM') },
  fiisC:     { title:'FIIs Comprados',  sub:'Fundos em carteira',               load:()=>loadTabela('FIIS_COMPRADOS','fiisC'), acts:()=>tableActs('FIIS_COMPRADOS','fiisC','FII',true) },
  fiisN:     { title:'FIIs Watchlist',  sub:'Fundos em anÃ¡lise',                load:()=>loadTabela('FIIS_NAO_COMPRADOS','fiisN'), acts:()=>tableActs('FIIS_NAO_COMPRADOS','fiisN','FII') },
  acC:       { title:'AÃ§Ãµes Compradas', sub:'Renda variÃ¡vel em carteira',       load:()=>loadTabela('ACOES_COMPRADOS','acC'), acts:()=>tableActs('ACOES_COMPRADOS','acC','ACAO',true) },
  acN:       { title:'AÃ§Ãµes Watchlist', sub:'AÃ§Ãµes em anÃ¡lise',                 load:()=>loadTabela('ACOES_NAO_COMPRADOS','acN'), acts:()=>tableActs('ACOES_NAO_COMPRADOS','acN','ACAO') },
  aportes:   { title:'Aportes',         sub:'Registro de compras mensais',      load:()=>loadTabela('APORTES','aportes'),     acts:()=>tableActs('APORTES','aportes','APORTE') },
  historico: { title:'HistÃ³rico',       sub:'EvoluÃ§Ã£o mensal do patrimÃ´nio',    load:()=>loadTabela('HISTORICO','historico'), acts:()=>[] },
  usuarios:  { title:'UsuÃ¡rios',        sub:'Controle de acesso ao sistema',    load:loadUsuarios,                           acts:()=>tableActs('USUARIOS','usuarios','USR') },
};
let activePage = 'dashboard';

function nav(el, page) {
  document.querySelectorAll('.sb-link').forEach(l => l.classList.remove('active'));
  el.classList.add('active');
  if(window.innerWidth<=600) document.getElementById('sidebar').classList.remove('open');
  carregarPagina(page);
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open')}
function carregarPagina(page) {
  activePage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('pg-' + page).classList.add('active');
  const pg = PAGES[page];
  document.getElementById('tbTitle').textContent = pg.title;
  document.getElementById('tbSub').textContent   = pg.sub;
  const acts = pg.acts();
  document.getElementById('tbActs').innerHTML = acts.map(a =>
    `<button class="btn ${a.cls}" onclick="${a.fn}">${a.label}</button>`
  ).join('');
  pg.load();
}
function dashActs() {
  return [
    { label:'â†» Atualizar', cls:'btn-ghost btn-sm', fn:'loadDashboard()' },
    { label:'âŸ³ PreÃ§os',   cls:'btn-ghost btn-sm', fn:'acionarPrecos()' },
  ];
}
function tableActs(aba, pg, tipo, comPrecos=false) {
  const acts = [
    { label:'â†»', cls:'btn-ghost btn-sm', fn:`reloadTable('${aba}','${pg}')` },
    { label:'+ Adicionar', cls:'btn-primary btn-sm', fn:`openModal('${aba}','${pg}',null,null,'${tipo}')` },
  ];
  if (comPrecos) acts.splice(1,0,{ label:'âŸ³ PreÃ§os', cls:'btn-ghost btn-sm', fn:'acionarPrecos()' });
  return acts;
}
function reloadTable(aba, pg) { loadTabela(aba, pg); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadDashboard() {
  el('pg-dashboard').innerHTML = loading();
  try {
    const d = await apiGet('getDashboard');
    renderDashboard(d);
  } catch(e) { el('pg-dashboard').innerHTML = `<div class="loading-row" style="color:var(--red)">Erro: ${e.message}</div>`; }
}
function fmt(v) {
  return 'R$\u00A0' + parseFloat(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
}
function pct(v) {
  const n = parseFloat(v||0);
  return (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
}
function renderDashboard(d) {
  const kpis = [
    { l:'PatrimÃ´nio Total', v:fmt(d.patrim),       c:'amber', s:'Carteira + CDB' },
    { l:'Total Investido',  v:fmt(d.totalInv),      c:'',      s:'FIIs + AÃ§Ãµes' },
    { l:'Retorno Geral',    v:pct(d.retGeral),      c:parseFloat(d.retGeral)>=0?'green':'red', s:'Sobre capital investido' },
    { l:'FIIs (Atual)',     v:fmt(d.fiiC.atual),    c:'blue',  s:d.fiiC.qtd+' ativos' },
    { l:'AÃ§Ãµes (Atual)',    v:fmt(d.acC.atual),     c:'',      s:d.acC.qtd+' ativos' },
    { l:'CDB (Atual)',      v:fmt(d.cdb.atual),     c:'',      s:'Renda fixa' },
    { l:'Aporte do MÃªs',   v:fmt(d.aporteMes),     c:'',      s:new Date().toLocaleString('pt-BR',{month:'long',year:'numeric'}) },
    { l:'FIIs Watchlist',  v:d.fiiN.qtd+' ativos', c:'',      s:fmt(d.fiiN.atual)+' potencial' },
  ];
  let h = '<div class="cards">' + kpis.map(k=>
    `<div class="kpi"><div class="kpi-label">${k.l}</div><div class="kpi-value ${k.c}">${k.v}</div><div class="kpi-sub">${k.s}</div></div>`
  ).join('') + '</div>';
  const rows = (d.historico && d.historico.rows) ? d.historico.rows.slice(-10) : [];
  h += `<div class="chart-card"><div class="chart-head"><span class="chart-title">EvoluÃ§Ã£o Patrimonial</span><span style="font-size:11px;color:var(--muted)">HistÃ³rico mensal</span></div>`;
  if (rows.length) {
    const vals = rows.map(r => parseFloat(r[3])||0), mx = Math.max(...vals,1);
    h += '<div class="chart-body">' + vals.map(v=>
      `<div class="bar" style="height:${Math.max(6,Math.round(v/mx*100))}%" data-tip="${fmt(v)}"></div>`
    ).join('') + '</div>';
    h += '<div class="chart-labels">' + rows.map(r=>`<span>${r[0]||''}</span>`).join('') + '</div>';
  } else {
    h += '<div style="color:var(--muted);font-size:13px;padding:10px 0">Sem histÃ³rico ainda.</div>';
  }
  h += '</div>';
  h += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">
    ${miniRes('FIIs Comprados',d.fiiC)}
    ${miniRes('AÃ§Ãµes Compradas',d.acC)}
  </div>`;
  el('pg-dashboard').innerHTML = h;
}
function miniRes(t, d) {
  return `<div class="tcard"><div class="tcard-head"><span class="tcard-title">${t}</span></div>
  <div style="padding:14px 20px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
    <div><div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Investido</div><div style="font-family:'DM Mono',monospace;margin-top:4px">${fmt(d.investido)}</div></div>
    <div><div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Atual</div><div style="font-family:'DM Mono',monospace;margin-top:4px">${fmt(d.atual)}</div></div>
    <div><div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Retorno</div><div style="font-family:'DM Mono',monospace;margin-top:4px;color:${parseFloat(d.retorno)>=0?'var(--green)':'var(--red)'}">${pct(d.retorno)}</div></div>
  </div></div>`;
}
async function acionarPrecos() {
  toast('Atualizando preÃ§os... aguarde (pode demorar ~30s)','info');
  try {
    const r = await apiGet('atualizarPrecos');
    toast(`âœ“ ${r.atualizados} preÃ§os atualizados Ã s ${r.hora}`,'ok');
    carregarPagina(activePage);
  } catch(e) { toast('Erro: '+e.message,'err'); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABELAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const COLS = {
  CDB:                { h:['Ticker','Tipo','Qtd','P.MÃ©dio','P.Atual','V.Investido','V.Atual','Retorno%','DY%','Ãšltimo DY','Atualizado'], money:[3,4,5,6,9], pct:[7,8] },
  FIIS_COMPRADOS:     { h:['Ticker','Tipo','Qtd','P.MÃ©dio','P.Atual','V.Investido','V.Atual','Retorno%','DY%','Ãšltimo DY','Atualizado'], money:[3,4,5,6,9], pct:[7,8] },
  FIIS_NAO_COMPRADOS: { h:['Ticker','Tipo','Qtd','P.Alvo','P.Atual','V.Investido','V.Atual','Retorno%','DY%','Ãšltimo DY','Atualizado'],  money:[3,4,5,6,9], pct:[7,8] },
  ACOES_COMPRADOS:    { h:['Ticker','Setor','Qtd','P.MÃ©dio','P.Atual','V.Investido','V.Atual','Retorno%','P/L','Atualizado'],             money:[3,4,5,6],   pct:[7] },
  ACOES_NAO_COMPRADOS:{ h:['Ticker','Setor','Qtd','P.Alvo','P.Atual','V.Investido','V.Atual','Retorno%','P/L','Atualizado'],              money:[3,4,5,6],   pct:[7] },
  APORTES:            { h:['Data','Ticker','Tipo','Qtd','PreÃ§o','Total','Corretora','ObservaÃ§Ã£o'],                                         money:[4,5],       pct:[] },
  HISTORICO:          { h:['Data','Carteira','Aporte MÃªs','PatrimÃ´nio','Rend.MÃªs','Rend.Acum.'],                                          money:[2,3,4,5],   pct:[] },
  USUARIOS:           { h:['Nome','Email','Senha'],                                                                                        money:[],          pct:[] },
};
async function loadTabela(aba, pg) {
  el('pg-'+pg).innerHTML = loading();
  try {
    const d   = await apiGet('lerAba', { aba });
    const cfg = COLS[aba] || { h: d.headers, money:[], pct:[] };
    const rows= d.rows || [];
    let h = '<div class="tcard"><div class="table-wrap"><table><thead><tr>' +
      cfg.h.map(c=>`<th>${c}</th>`).join('') + '<th></th></tr></thead><tbody>';
    if (!rows.length) h += `<tr><td colspan="${cfg.h.length+1}" class="td-empty">Nenhum registro. Clique em "+ Adicionar".</td></tr>`;
    rows.forEach((row,ri) => {
      h += '<tr>';
      row.forEach((cell,ci) => {
        let v = (cell!==null&&cell!==undefined&&cell!=='') ? cell : 'â€”';
        let c = 'td-num';
        if (ci===0) c='td-ticker';
        if (cfg.pct.includes(ci)) {
          const n=parseFloat(v);
          c=isNaN(n)?'':(n>=0?'td-pos':'td-neg');
          v=isNaN(n)?v:(n>=0?'+':'')+n.toFixed(2)+'%';
        } else if (cfg.money.includes(ci)&&!isNaN(parseFloat(v))&&v!=='â€”') {
          v=fmt(v);
        }
        h+=`<td class="${c}">${v}</td>`;
      });
      h+=`<td><div class="td-acts">
        <button class="btn btn-blue btn-sm" onclick="editarLinha('${aba}','${pg}',${ri})">âœ</button>
        <button class="btn btn-danger btn-sm" onclick="excluirLinha('${aba}','${pg}',${ri+1})">âœ•</button>
      </div></td></tr>`;
    });
    h+='</tbody></table></div></div>';
    el('pg-'+pg).innerHTML=h;
  } catch(e){ el('pg-'+pg).innerHTML=`<div class="loading-row" style="color:var(--red)">Erro: ${e.message}</div>`; }
}
async function loadUsuarios() {
  el('pg-usuarios').innerHTML = loading();
  try {
    const d=await apiGet('lerAba',{aba:'USUARIOS'});
    let h='<div class="tcard"><div class="table-wrap"><table><thead><tr><th>Nome</th><th>Email</th><th>Senha</th><th></th></tr></thead><tbody>';
    if(!d.rows.length) h+='<tr><td colspan="4" class="td-empty">Nenhum usuÃ¡rio cadastrado</td></tr>';
    d.rows.forEach((r,ri)=>{
      h+=`<tr><td>${r[0]||'â€”'}</td><td>${r[1]||'â€”'}</td><td>â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</td>
      <td><button class="btn btn-danger btn-sm" onclick="excluirLinha('USUARIOS','usuarios',${ri+1})">âœ• Excluir</button></td></tr>`;
    });
    h+='</tbody></table></div></div>';
    el('pg-usuarios').innerHTML=h;
  } catch(e){ el('pg-usuarios').innerHTML=`<div class="loading-row" style="color:var(--red)">Erro: ${e.message}</div>`; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FORMS = {
  FII:[
    {id:'ticker',label:'Ticker',type:'text'},{id:'tipo',label:'Tipo',type:'text'},
    {id:'qtd',label:'Quantidade',type:'number'},{id:'pm',label:'PreÃ§o MÃ©dio/Alvo',type:'number',step:'0.01'},
    {id:'pa',label:'PreÃ§o Atual',type:'number',step:'0.01'},
    {id:'dy',label:'DY %',type:'number',step:'0.01'},{id:'ultDY',label:'Ãšltimo DY (R$)',type:'number',step:'0.01'},
  ],
  ACAO:[
    {id:'ticker',label:'Ticker',type:'text'},{id:'setor',label:'Setor',type:'text'},
    {id:'qtd',label:'Quantidade',type:'number'},{id:'pm',label:'PreÃ§o MÃ©dio/Alvo',type:'number',step:'0.01'},
    {id:'pa',label:'PreÃ§o Atual',type:'number',step:'0.01'},
    {id:'pl',label:'P/L',type:'number',step:'0.01'},
  ],
  CDB_FORM:[
    {id:'ticker',label:'Ticker/Nome',type:'text'},{id:'tipo',label:'Tipo (CDB/LCI/LCA)',type:'text'},
    {id:'qtd',label:'Quantidade',type:'number'},{id:'pm',label:'PreÃ§o MÃ©dio',type:'number',step:'0.01'},
    {id:'pa',label:'PreÃ§o Atual',type:'number',step:'0.01'},
    {id:'dy',label:'DY %',type:'number',step:'0.01'},{id:'ultDY',label:'Ãšltimo DY (R$)',type:'number',step:'0.01'},
  ],
  APORTE:[
    {id:'data',label:'Data',type:'date',full:true},{id:'ticker',label:'Ticker',type:'text'},
    {id:'tipo',label:'Tipo (FII/AÃ‡ÃƒO/CDB)',type:'text'},{id:'qtd',label:'Quantidade',type:'number'},
    {id:'preco',label:'PreÃ§o (R$)',type:'number',step:'0.01'},{id:'corretora',label:'Corretora',type:'text'},
    {id:'obs',label:'ObservaÃ§Ã£o',type:'text',full:true},
  ],
  USR:[
    {id:'nome',label:'Nome completo',type:'text',full:true},
    {id:'email',label:'Email',type:'email'},{id:'senha',label:'Senha',type:'password'},
  ],
};
let _mAba,_mPg,_mRow,_mData,_mTipo;
function openModal(aba,pg,rowIdx,rowData,tipo){
  _mAba=aba;_mPg=pg;_mRow=rowIdx;_mData=rowData;_mTipo=tipo;
  const fKey=tipo==='FII'?'FII':tipo==='ACAO'?'ACAO':tipo==='APORTE'?'APORTE':tipo==='USR'?'USR':'CDB_FORM';
  const fields=FORMS[fKey]||[];
  el('modalTitle').textContent = rowIdx!==null?'Editar Registro':'Novo Registro';
  let h='<div class="fgrid">';
  fields.forEach((f,i)=>{
    const v=(rowData&&rowData[i]!==undefined)?rowData[i]:'';
    h+=`<div class="fg ${f.full?'full':''}"><label>${f.label}</label>
      <input id="mf_${f.id}" type="${f.type}" value="${String(v).replace(/"/g,'&quot;')}" placeholder="${f.label}" ${f.step?`step="${f.step}"`:''}/>
    </div>`;
  });
  h+='</div>';
  el('modalForm').innerHTML=h;
  el('overlay').classList.add('open');
}
async function editarLinha(aba,pg,ri){
  try{
    const d=await apiGet('lerAba',{aba});
    const row=d.rows[ri];
    const tipo=aba.includes('FIIS')?'FII':aba.includes('ACOES')?'ACAO':aba==='APORTES'?'APORTE':aba==='USUARIOS'?'USR':'CDB_FORM';
    openModal(aba,pg,ri+1,row,tipo);
  }catch(e){toast('Erro: '+e.message,'err');}
}
async function excluirLinha(aba,pg,rowIndex){
  if(!confirm('Excluir este registro?')) return;
  try{
    await apiWrite('deletarLinha',{aba,rowIndex});
    toast('ExcluÃ­do!','ok');
    if(aba==='USUARIOS') loadUsuarios(); else loadTabela(aba,pg);
  }catch(e){toast('Erro: '+e.message,'err');}
}
function closeModal(){el('overlay').classList.remove('open')}
function closeModalOutside(e){if(e.target===el('overlay'))closeModal();}
async function saveModal(){
  const fKey=_mTipo==='FII'?'FII':_mTipo==='ACAO'?'ACAO':_mTipo==='APORTE'?'APORTE':_mTipo==='USR'?'USR':'CDB_FORM';
  const fields=FORMS[fKey]||[];
  const raw=fields.map(f=>el('mf_'+f.id)?.value||'');
  let linha;
  const agora=new Date().toLocaleString('pt-BR');
  const n=v=>parseFloat(v)||0;
  const fix=(v,d=2)=>(+parseFloat(v).toFixed(d))||0;
  if(_mTipo==='FII'||_mTipo==='CDB_FORM'){
    const[ticker,tipo,qtd,pm,pa,dy,ultDY]=raw;
    const vi=fix(n(qtd)*n(pm));const va=fix(n(qtd)*n(pa));
    const ret=n(pm)>0?fix((n(pa)-n(pm))/n(pm)*100):0;
    linha=[ticker,tipo,qtd,pm,pa,vi,va,ret,dy,ultDY,agora];
  }else if(_mTipo==='ACAO'){
    const[ticker,setor,qtd,pm,pa,pl]=raw;
    const vi=fix(n(qtd)*n(pm));const va=fix(n(qtd)*n(pa));
    const ret=n(pm)>0?fix((n(pa)-n(pm))/n(pm)*100):0;
    linha=[ticker,setor,qtd,pm,pa,vi,va,ret,pl,agora];
  }else if(_mTipo==='APORTE'){
    const[data,ticker,tipo,qtd,preco,corretora,obs]=raw;
    linha=[data,ticker,tipo,qtd,preco,fix(n(qtd)*n(preco)),corretora,obs];
  }else{
    linha=raw;
  }
  try{
    if(_mRow!==null){
      await apiWrite('atualizarLinha',{aba:_mAba,rowIndex:_mRow,linha});
      toast('Atualizado!','ok');
    }else{
      await apiWrite('adicionarLinha',{aba:_mAba,linha});
      toast('Adicionado!','ok');
    }
    closeModal();
    if(_mAba==='USUARIOS') loadUsuarios(); else loadTabela(_mAba,_mPg);
  }catch(e){toast('Erro ao salvar: '+e.message,'err');}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function el(id){return document.getElementById(id)}
function setErr(id,msg){el(id).textContent=msg}
function loading(){return '<div class="loading-row"><span class="spin"></span> Carregando...</div>'}
function toast(msg,type='info'){
  const t=el('toast'),ico=el('toastIco'),txt=el('toastMsg');
  txt.textContent=msg;
  ico.textContent=type==='ok'?'âœ“':type==='err'?'âœ•':'â„¹';
  t.className='show '+type;
  clearTimeout(window._tt);window._tt=setTimeout(()=>t.className='',4000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function boot(){
  initTheme();
  const url=localStorage.getItem(LS_URL);
  if(url){
    API=url;
    el('cfgBanner').style.display='none';
    const usr=localStorage.getItem(LS_USR);
    if(usr){
      try{
        currentUser=JSON.parse(usr);
        el('sbNome').textContent=currentUser.nome;
        el('sbEmail').textContent=currentUser.email;
        el('app').classList.add('show');
        carregarPagina('dashboard');
        return;
      }catch(_){}
    }
    el('loginScreen').classList.add('show');
  }
  document.addEventListener('keyup',e=>{
    if(e.key==='Enter' && el('loginScreen').classList.contains('show')) fazerLogin();
    if(e.key==='Escape') closeModal();
  });
})();
</script>
</body>
</html>
